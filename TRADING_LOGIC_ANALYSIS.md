# 回测系统交易逻辑完整性分析报告

## 📊 当前实现状态

### ✅ 已实现的聚宽兼容特性

| 功能             | 实现状态      | 聚宽一致性    | 说明                                     |
| ---------------- | ------------- | ------------- | ---------------------------------------- |
| **涨跌停限制**   | ✅ 已实现     | ⚠️ 部分一致   | 检测涨跌停并阻止下单，但缺少停牌检测     |
| **手续费模型**   | ✅ 已实现     | ✅ 完全一致   | 佣金率 0.03%、最小佣金 5 元、印花税 0.1% |
| **滑点模型**     | ✅ 已实现     | ✅ 完全一致   | 默认 0.246%半滑点模型                    |
| **价格限制**     | ✅ 已实现     | ✅ 完全一致   | 价格最小变动单位 0.01 元                 |
| **股票池功能**   | ✅ 已实现     | ✅ 完全一致   | get_index_stocks/weights 等              |
| **T+1 制度**     | ❌ **未实现** | ❌ **不一致** | **缺失关键功能**                         |
| **100 股整数倍** | ⚠️ 部分实现   | ⚠️ 部分一致   | 有逻辑但可能不完整                       |
| **停牌处理**     | ❌ **未实现** | ❌ **不一致** | **缺失关键功能**                         |
| **ST 股票限制**  | ❌ **未实现** | ❌ **不一致** | 可选功能                                 |

---

## 🔴 关键缺失功能详解

### 1. T+1 交易制度 ⚠️ **高优先级**

**聚宽行为**：

- 当日买入的股票，当日不能卖出
- 只有昨日及之前持仓可以卖出
- `context.portfolio.positions[stock].closeable_amount` 返回可卖数量

**当前系统问题**：

```python
# backend/app/backtest_engine.py 第358行
closeable_amount=int(self.position.size)  # ❌ 错误！返回的是总持仓，不是可卖持仓
```

**影响**：

- 允许当天买入的股票当天卖出（T+0）
- 与 A 股实际交易规则不符
- 回测结果可能过于乐观

**解决方案**：
需要跟踪每日买入数量，计算可卖数量：

```python
可卖数量 = 总持仓 - 当日买入数量
```

---

### 2. 停牌处理 ⚠️ **高优先级**

**聚宽行为**：

- 停牌期间不允许交易
- 停牌股票不参与调仓
- 提供 `get_paused()` 函数查询停牌状态

**当前系统问题**：

- 没有停牌数据
- 没有停牌检测逻辑
- 可能在停牌期间下单成功

**影响**：

- 回测结果不真实
- 策略在实盘可能无法执行

**解决方案**：

1. 补充停牌数据文件
2. 在下单前检查停牌状态
3. 实现 `get_paused()` 函数

---

### 3. 100 股整数倍限制 ⚠️ **中优先级**

**聚宽行为**：

- 买入必须是 100 股的整数倍
- 卖出可以卖零股（清仓时）
- 自动向下取整到 100 的倍数

**当前系统状态**：
代码中有部分逻辑，但需要验证完整性

**检查点**：

```python
# 搜索 "lot" 或 "100" 相关逻辑
shares = (shares // 100) * 100  # 应该有这样的逻辑
```

---

## 📝 涨跌停实现分析

### 当前实现（第 1455-1497 行）

```python
# ✅ 已实现基本涨跌停检测
def _limit_guard(strategy_self, *a, **kw):
    cur_price = ...  # 当前价格
    prev_close = ...  # 昨收价

    up_lim = prev_close * 1.10  # 涨停价
    if cur_price >= up_lim:
        # 阻止买入
        return None
```

**优点**：

- ✅ 正确计算涨跌停价格
- ✅ 阻止涨停买入、跌停卖出
- ✅ 记录被阻断的订单

**改进建议**：

1. 考虑科创板/创业板 20%涨跌幅
2. 考虑 ST 股票 5%涨跌幅
3. 考虑北交所 30%涨跌幅

---

## 💰 手续费实现分析

### 当前实现（第 1862-1905 行）

```python
# ✅ 聚宽完全一致的费用模型
rate = 0.0003           # 0.03% 佣金率
min_commission = 5.0    # 最小佣金5元
stamp_duty = 0.001      # 卖出印花税0.1%

total_fee = max(value * rate, min_commission) + (value * stamp_duty if SELL else 0)
```

**优点**：

- ✅ 与聚宽默认费率完全一致
- ✅ 正确应用最小佣金
- ✅ 正确应用印花税（仅卖出）
- ✅ 支持用户自定义费率

**完美！无需改进**

---

## 🎯 滑点实现分析

### 当前实现（第 245-280 行）

```python
# ✅ 聚宽一致的滑点模型
slippage_perc = 0.00246  # 默认0.246%

# 半滑点模型：
# 买入价 = 基准价 * (1 + slippage_perc / 2)
# 卖出价 = 基准价 * (1 - slippage_perc / 2)
```

**优点**：

- ✅ 默认值与聚宽一致
- ✅ 半滑点模型正确
- ✅ 支持固定滑点和百分比滑点

**完美！无需改进**

---

## 🔧 急需优化的功能

### 优先级 1：实现 T+1 制度 🔴

**代码位置**：`backend/app/backtest_engine.py`

**实现思路**：

```python
class _Portfolio:
    def __init__(self):
        self._daily_bought = {}  # 记录每日买入数量
        self._current_date = None

    @property
    def positions(self):
        # 计算可卖数量
        total = self.position.size
        today_bought = self._daily_bought.get(self._current_date, 0)
        closeable = total - today_bought

        return {
            stock: SimpleNamespace(
                closeable_amount=max(0, closeable),
                total_amount=total
            )
        }
```

---

### 优先级 2：补充停牌数据 🔴

**数据格式建议**：

创建目录：`stockdata/stockdata/停牌数据/`

文件格式：`{stock_code}.csv`

```csv
股票代码,停牌开始日期,停牌结束日期,停牌原因
000001.SZ,2024-03-15,2024-03-20,重大资产重组
000001.SZ,2024-06-10,2024-06-10,临时停牌
```

**检测逻辑**：

```python
def is_paused(stock, date):
    """检查股票是否停牌"""
    # 查询停牌数据
    # 返回 True/False
```

---

### 优先级 3：完善 100 股整数倍逻辑 🟡

**验证代码**：

```python
# 检查所有下单逻辑
shares = order_value / price
shares = (shares // 100) * 100  # 向下取整到100的倍数

if shares < 100:
    # 买入不足100股，取消订单
    return None
```

---

## 📊 与聚宽对比总结

### 完全一致的部分 ✅

1. **手续费模型** - 100%一致
2. **滑点模型** - 100%一致
3. **涨跌停检测** - 基本一致（需扩展板块差异）
4. **股票池功能** - API 完全一致
5. **价格精度** - 0.01 元一致

### 需要改进的部分 ⚠️

1. **T+1 制度** - 0% 实现（关键缺失）
2. **停牌处理** - 0% 实现（关键缺失）
3. **100 股整数倍** - 50% 实现（需验证）
4. **涨跌幅板块差异** - 30% 实现（仅支持主板 10%）

---

## 🎯 优化建议优先级

### 立即实施（影响回测准确性）

1. ✅ **实现 T+1 制度**

   - 添加每日买入跟踪
   - 修正 closeable_amount 计算
   - 测试验证

2. ✅ **添加停牌检测**
   - 补充停牌数据
   - 实现检测逻辑
   - 集成到下单流程

### 短期优化（提升真实性）

3. ✅ **完善涨跌幅差异**

   - 科创板 20%
   - 创业板 20%（注册制后）
   - ST 股票 5%
   - 北交所 30%

4. ✅ **验证 100 股整数倍**
   - 检查所有下单路径
   - 添加单元测试

### 长期优化（增强功能）

5. ⚠️ **ST 股票标记**

   - 补充 ST 数据
   - 实现过滤逻辑

6. ⚠️ **退市股票处理**
   - 退市日期数据
   - 强制清仓逻辑

---

## 📋 数据补充清单

### 急需补充的数据

| 数据类型 | 目录                             | 优先级 | 说明           |
| -------- | -------------------------------- | ------ | -------------- |
| 停牌数据 | `stockdata/stockdata/停牌数据/`  | 🔴 高  | 影响交易可行性 |
| ST 标记  | `stockdata/stockdata/st_status/` | 🟡 中  | 风险控制       |
| 退市数据 | `stockdata/stockdata/退市数据/`  | 🟢 低  | 边缘情况       |
| 板块分类 | `stockdata/stockdata/板块分类/`  | 🟡 中  | 涨跌幅差异     |

---

## 🧪 测试建议

### 创建测试用例

1. **T+1 测试**

   ```python
   # 测试当日买入不能当日卖出
   day1: buy 1000 shares
   day1: sell 1000 shares  # 应该失败
   day2: sell 1000 shares  # 应该成功
   ```

2. **涨跌停测试**

   ```python
   # 测试涨停不能买入
   stock at limit_up: buy()  # 应该失败
   stock at limit_down: sell()  # 应该失败
   ```

3. **停牌测试**
   ```python
   # 测试停牌期间不能交易
   if is_paused(stock):
       buy(stock)  # 应该失败
   ```

---

## 📊 总体评分

| 维度     | 得分   | 满分   | 说明                 |
| -------- | ------ | ------ | -------------------- |
| 费用模型 | 10     | 10     | 完美实现             |
| 滑点模型 | 10     | 10     | 完美实现             |
| 涨跌停   | 7      | 10     | 基本实现，缺板块差异 |
| T+1 制度 | 0      | 10     | **未实现**           |
| 停牌处理 | 0      | 10     | **未实现**           |
| 整数倍   | 5      | 10     | 部分实现             |
| **总分** | **32** | **60** | **53.3%**            |

---

## 🎯 下一步行动

### 第一阶段：核心功能（1-2 天）

- [ ] 实现 T+1 制度
- [ ] 添加停牌数据和检测
- [ ] 验证 100 股整数倍逻辑

### 第二阶段：功能完善（3-5 天）

- [ ] 实现涨跌幅板块差异
- [ ] 添加 ST 股票过滤
- [ ] 补充测试用例

### 第三阶段：数据补充（持续）

- [ ] 收集停牌数据
- [ ] 收集 ST 标记数据
- [ ] 收集板块分类数据

---

**评估结论**：

你的回测系统在**费用和滑点模型**方面已经与聚宽**完全一致**，这是非常好的基础。但是在**交易规则**方面（特别是 T+1 和停牌处理）还有明显不足。

建议**优先实现 T+1 制度**，这是 A 股市场最基本的交易规则，对回测结果影响很大。

---

**文档版本**: v1.0  
**评估日期**: 2025-10-08  
**评估人**: Backtest System Analysis Team
