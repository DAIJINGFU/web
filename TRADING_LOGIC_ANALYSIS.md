# å›æµ‹ç³»ç»Ÿäº¤æ˜“é€»è¾‘å®Œæ•´æ€§åˆ†ææŠ¥å‘Š

## ğŸ“Š å½“å‰å®ç°çŠ¶æ€

### âœ… å·²å®ç°çš„èšå®½å…¼å®¹ç‰¹æ€§

| åŠŸèƒ½             | å®ç°çŠ¶æ€      | èšå®½ä¸€è‡´æ€§    | è¯´æ˜                                     |
| ---------------- | ------------- | ------------- | ---------------------------------------- |
| **æ¶¨è·Œåœé™åˆ¶**   | âœ… å·²å®ç°     | âš ï¸ éƒ¨åˆ†ä¸€è‡´   | æ£€æµ‹æ¶¨è·Œåœå¹¶é˜»æ­¢ä¸‹å•ï¼Œä½†ç¼ºå°‘åœç‰Œæ£€æµ‹     |
| **æ‰‹ç»­è´¹æ¨¡å‹**   | âœ… å·²å®ç°     | âœ… å®Œå…¨ä¸€è‡´   | ä½£é‡‘ç‡ 0.03%ã€æœ€å°ä½£é‡‘ 5 å…ƒã€å°èŠ±ç¨ 0.1% |
| **æ»‘ç‚¹æ¨¡å‹**     | âœ… å·²å®ç°     | âœ… å®Œå…¨ä¸€è‡´   | é»˜è®¤ 0.246%åŠæ»‘ç‚¹æ¨¡å‹                    |
| **ä»·æ ¼é™åˆ¶**     | âœ… å·²å®ç°     | âœ… å®Œå…¨ä¸€è‡´   | ä»·æ ¼æœ€å°å˜åŠ¨å•ä½ 0.01 å…ƒ                 |
| **è‚¡ç¥¨æ± åŠŸèƒ½**   | âœ… å·²å®ç°     | âœ… å®Œå…¨ä¸€è‡´   | get_index_stocks/weights ç­‰              |
| **T+1 åˆ¶åº¦**     | âŒ **æœªå®ç°** | âŒ **ä¸ä¸€è‡´** | **ç¼ºå¤±å…³é”®åŠŸèƒ½**                         |
| **100 è‚¡æ•´æ•°å€** | âš ï¸ éƒ¨åˆ†å®ç°   | âš ï¸ éƒ¨åˆ†ä¸€è‡´   | æœ‰é€»è¾‘ä½†å¯èƒ½ä¸å®Œæ•´                       |
| **åœç‰Œå¤„ç†**     | âŒ **æœªå®ç°** | âŒ **ä¸ä¸€è‡´** | **ç¼ºå¤±å…³é”®åŠŸèƒ½**                         |
| **ST è‚¡ç¥¨é™åˆ¶**  | âŒ **æœªå®ç°** | âŒ **ä¸ä¸€è‡´** | å¯é€‰åŠŸèƒ½                                 |

---

## ğŸ”´ å…³é”®ç¼ºå¤±åŠŸèƒ½è¯¦è§£

### 1. T+1 äº¤æ˜“åˆ¶åº¦ âš ï¸ **é«˜ä¼˜å…ˆçº§**

**èšå®½è¡Œä¸º**ï¼š

- å½“æ—¥ä¹°å…¥çš„è‚¡ç¥¨ï¼Œå½“æ—¥ä¸èƒ½å–å‡º
- åªæœ‰æ˜¨æ—¥åŠä¹‹å‰æŒä»“å¯ä»¥å–å‡º
- `context.portfolio.positions[stock].closeable_amount` è¿”å›å¯å–æ•°é‡

**å½“å‰ç³»ç»Ÿé—®é¢˜**ï¼š

```python
# backend/app/backtest_engine.py ç¬¬358è¡Œ
closeable_amount=int(self.position.size)  # âŒ é”™è¯¯ï¼è¿”å›çš„æ˜¯æ€»æŒä»“ï¼Œä¸æ˜¯å¯å–æŒä»“
```

**å½±å“**ï¼š

- å…è®¸å½“å¤©ä¹°å…¥çš„è‚¡ç¥¨å½“å¤©å–å‡ºï¼ˆT+0ï¼‰
- ä¸ A è‚¡å®é™…äº¤æ˜“è§„åˆ™ä¸ç¬¦
- å›æµ‹ç»“æœå¯èƒ½è¿‡äºä¹è§‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
éœ€è¦è·Ÿè¸ªæ¯æ—¥ä¹°å…¥æ•°é‡ï¼Œè®¡ç®—å¯å–æ•°é‡ï¼š

```python
å¯å–æ•°é‡ = æ€»æŒä»“ - å½“æ—¥ä¹°å…¥æ•°é‡
```

---

### 2. åœç‰Œå¤„ç† âš ï¸ **é«˜ä¼˜å…ˆçº§**

**èšå®½è¡Œä¸º**ï¼š

- åœç‰ŒæœŸé—´ä¸å…è®¸äº¤æ˜“
- åœç‰Œè‚¡ç¥¨ä¸å‚ä¸è°ƒä»“
- æä¾› `get_paused()` å‡½æ•°æŸ¥è¯¢åœç‰ŒçŠ¶æ€

**å½“å‰ç³»ç»Ÿé—®é¢˜**ï¼š

- æ²¡æœ‰åœç‰Œæ•°æ®
- æ²¡æœ‰åœç‰Œæ£€æµ‹é€»è¾‘
- å¯èƒ½åœ¨åœç‰ŒæœŸé—´ä¸‹å•æˆåŠŸ

**å½±å“**ï¼š

- å›æµ‹ç»“æœä¸çœŸå®
- ç­–ç•¥åœ¨å®ç›˜å¯èƒ½æ— æ³•æ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. è¡¥å……åœç‰Œæ•°æ®æ–‡ä»¶
2. åœ¨ä¸‹å•å‰æ£€æŸ¥åœç‰ŒçŠ¶æ€
3. å®ç° `get_paused()` å‡½æ•°

---

### 3. 100 è‚¡æ•´æ•°å€é™åˆ¶ âš ï¸ **ä¸­ä¼˜å…ˆçº§**

**èšå®½è¡Œä¸º**ï¼š

- ä¹°å…¥å¿…é¡»æ˜¯ 100 è‚¡çš„æ•´æ•°å€
- å–å‡ºå¯ä»¥å–é›¶è‚¡ï¼ˆæ¸…ä»“æ—¶ï¼‰
- è‡ªåŠ¨å‘ä¸‹å–æ•´åˆ° 100 çš„å€æ•°

**å½“å‰ç³»ç»ŸçŠ¶æ€**ï¼š
ä»£ç ä¸­æœ‰éƒ¨åˆ†é€»è¾‘ï¼Œä½†éœ€è¦éªŒè¯å®Œæ•´æ€§

**æ£€æŸ¥ç‚¹**ï¼š

```python
# æœç´¢ "lot" æˆ– "100" ç›¸å…³é€»è¾‘
shares = (shares // 100) * 100  # åº”è¯¥æœ‰è¿™æ ·çš„é€»è¾‘
```

---

## ğŸ“ æ¶¨è·Œåœå®ç°åˆ†æ

### å½“å‰å®ç°ï¼ˆç¬¬ 1455-1497 è¡Œï¼‰

```python
# âœ… å·²å®ç°åŸºæœ¬æ¶¨è·Œåœæ£€æµ‹
def _limit_guard(strategy_self, *a, **kw):
    cur_price = ...  # å½“å‰ä»·æ ¼
    prev_close = ...  # æ˜¨æ”¶ä»·

    up_lim = prev_close * 1.10  # æ¶¨åœä»·
    if cur_price >= up_lim:
        # é˜»æ­¢ä¹°å…¥
        return None
```

**ä¼˜ç‚¹**ï¼š

- âœ… æ­£ç¡®è®¡ç®—æ¶¨è·Œåœä»·æ ¼
- âœ… é˜»æ­¢æ¶¨åœä¹°å…¥ã€è·Œåœå–å‡º
- âœ… è®°å½•è¢«é˜»æ–­çš„è®¢å•

**æ”¹è¿›å»ºè®®**ï¼š

1. è€ƒè™‘ç§‘åˆ›æ¿/åˆ›ä¸šæ¿ 20%æ¶¨è·Œå¹…
2. è€ƒè™‘ ST è‚¡ç¥¨ 5%æ¶¨è·Œå¹…
3. è€ƒè™‘åŒ—äº¤æ‰€ 30%æ¶¨è·Œå¹…

---

## ğŸ’° æ‰‹ç»­è´¹å®ç°åˆ†æ

### å½“å‰å®ç°ï¼ˆç¬¬ 1862-1905 è¡Œï¼‰

```python
# âœ… èšå®½å®Œå…¨ä¸€è‡´çš„è´¹ç”¨æ¨¡å‹
rate = 0.0003           # 0.03% ä½£é‡‘ç‡
min_commission = 5.0    # æœ€å°ä½£é‡‘5å…ƒ
stamp_duty = 0.001      # å–å‡ºå°èŠ±ç¨0.1%

total_fee = max(value * rate, min_commission) + (value * stamp_duty if SELL else 0)
```

**ä¼˜ç‚¹**ï¼š

- âœ… ä¸èšå®½é»˜è®¤è´¹ç‡å®Œå…¨ä¸€è‡´
- âœ… æ­£ç¡®åº”ç”¨æœ€å°ä½£é‡‘
- âœ… æ­£ç¡®åº”ç”¨å°èŠ±ç¨ï¼ˆä»…å–å‡ºï¼‰
- âœ… æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è´¹ç‡

**å®Œç¾ï¼æ— éœ€æ”¹è¿›**

---

## ğŸ¯ æ»‘ç‚¹å®ç°åˆ†æ

### å½“å‰å®ç°ï¼ˆç¬¬ 245-280 è¡Œï¼‰

```python
# âœ… èšå®½ä¸€è‡´çš„æ»‘ç‚¹æ¨¡å‹
slippage_perc = 0.00246  # é»˜è®¤0.246%

# åŠæ»‘ç‚¹æ¨¡å‹ï¼š
# ä¹°å…¥ä»· = åŸºå‡†ä»· * (1 + slippage_perc / 2)
# å–å‡ºä»· = åŸºå‡†ä»· * (1 - slippage_perc / 2)
```

**ä¼˜ç‚¹**ï¼š

- âœ… é»˜è®¤å€¼ä¸èšå®½ä¸€è‡´
- âœ… åŠæ»‘ç‚¹æ¨¡å‹æ­£ç¡®
- âœ… æ”¯æŒå›ºå®šæ»‘ç‚¹å’Œç™¾åˆ†æ¯”æ»‘ç‚¹

**å®Œç¾ï¼æ— éœ€æ”¹è¿›**

---

## ğŸ”§ æ€¥éœ€ä¼˜åŒ–çš„åŠŸèƒ½

### ä¼˜å…ˆçº§ 1ï¼šå®ç° T+1 åˆ¶åº¦ ğŸ”´

**ä»£ç ä½ç½®**ï¼š`backend/app/backtest_engine.py`

**å®ç°æ€è·¯**ï¼š

```python
class _Portfolio:
    def __init__(self):
        self._daily_bought = {}  # è®°å½•æ¯æ—¥ä¹°å…¥æ•°é‡
        self._current_date = None

    @property
    def positions(self):
        # è®¡ç®—å¯å–æ•°é‡
        total = self.position.size
        today_bought = self._daily_bought.get(self._current_date, 0)
        closeable = total - today_bought

        return {
            stock: SimpleNamespace(
                closeable_amount=max(0, closeable),
                total_amount=total
            )
        }
```

---

### ä¼˜å…ˆçº§ 2ï¼šè¡¥å……åœç‰Œæ•°æ® ğŸ”´

**æ•°æ®æ ¼å¼å»ºè®®**ï¼š

åˆ›å»ºç›®å½•ï¼š`stockdata/stockdata/åœç‰Œæ•°æ®/`

æ–‡ä»¶æ ¼å¼ï¼š`{stock_code}.csv`

```csv
è‚¡ç¥¨ä»£ç ,åœç‰Œå¼€å§‹æ—¥æœŸ,åœç‰Œç»“æŸæ—¥æœŸ,åœç‰ŒåŸå› 
000001.SZ,2024-03-15,2024-03-20,é‡å¤§èµ„äº§é‡ç»„
000001.SZ,2024-06-10,2024-06-10,ä¸´æ—¶åœç‰Œ
```

**æ£€æµ‹é€»è¾‘**ï¼š

```python
def is_paused(stock, date):
    """æ£€æŸ¥è‚¡ç¥¨æ˜¯å¦åœç‰Œ"""
    # æŸ¥è¯¢åœç‰Œæ•°æ®
    # è¿”å› True/False
```

---

### ä¼˜å…ˆçº§ 3ï¼šå®Œå–„ 100 è‚¡æ•´æ•°å€é€»è¾‘ ğŸŸ¡

**éªŒè¯ä»£ç **ï¼š

```python
# æ£€æŸ¥æ‰€æœ‰ä¸‹å•é€»è¾‘
shares = order_value / price
shares = (shares // 100) * 100  # å‘ä¸‹å–æ•´åˆ°100çš„å€æ•°

if shares < 100:
    # ä¹°å…¥ä¸è¶³100è‚¡ï¼Œå–æ¶ˆè®¢å•
    return None
```

---

## ğŸ“Š ä¸èšå®½å¯¹æ¯”æ€»ç»“

### å®Œå…¨ä¸€è‡´çš„éƒ¨åˆ† âœ…

1. **æ‰‹ç»­è´¹æ¨¡å‹** - 100%ä¸€è‡´
2. **æ»‘ç‚¹æ¨¡å‹** - 100%ä¸€è‡´
3. **æ¶¨è·Œåœæ£€æµ‹** - åŸºæœ¬ä¸€è‡´ï¼ˆéœ€æ‰©å±•æ¿å—å·®å¼‚ï¼‰
4. **è‚¡ç¥¨æ± åŠŸèƒ½** - API å®Œå…¨ä¸€è‡´
5. **ä»·æ ¼ç²¾åº¦** - 0.01 å…ƒä¸€è‡´

### éœ€è¦æ”¹è¿›çš„éƒ¨åˆ† âš ï¸

1. **T+1 åˆ¶åº¦** - 0% å®ç°ï¼ˆå…³é”®ç¼ºå¤±ï¼‰
2. **åœç‰Œå¤„ç†** - 0% å®ç°ï¼ˆå…³é”®ç¼ºå¤±ï¼‰
3. **100 è‚¡æ•´æ•°å€** - 50% å®ç°ï¼ˆéœ€éªŒè¯ï¼‰
4. **æ¶¨è·Œå¹…æ¿å—å·®å¼‚** - 30% å®ç°ï¼ˆä»…æ”¯æŒä¸»æ¿ 10%ï¼‰

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

### ç«‹å³å®æ–½ï¼ˆå½±å“å›æµ‹å‡†ç¡®æ€§ï¼‰

1. âœ… **å®ç° T+1 åˆ¶åº¦**

   - æ·»åŠ æ¯æ—¥ä¹°å…¥è·Ÿè¸ª
   - ä¿®æ­£ closeable_amount è®¡ç®—
   - æµ‹è¯•éªŒè¯

2. âœ… **æ·»åŠ åœç‰Œæ£€æµ‹**
   - è¡¥å……åœç‰Œæ•°æ®
   - å®ç°æ£€æµ‹é€»è¾‘
   - é›†æˆåˆ°ä¸‹å•æµç¨‹

### çŸ­æœŸä¼˜åŒ–ï¼ˆæå‡çœŸå®æ€§ï¼‰

3. âœ… **å®Œå–„æ¶¨è·Œå¹…å·®å¼‚**

   - ç§‘åˆ›æ¿ 20%
   - åˆ›ä¸šæ¿ 20%ï¼ˆæ³¨å†Œåˆ¶åï¼‰
   - ST è‚¡ç¥¨ 5%
   - åŒ—äº¤æ‰€ 30%

4. âœ… **éªŒè¯ 100 è‚¡æ•´æ•°å€**
   - æ£€æŸ¥æ‰€æœ‰ä¸‹å•è·¯å¾„
   - æ·»åŠ å•å…ƒæµ‹è¯•

### é•¿æœŸä¼˜åŒ–ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰

5. âš ï¸ **ST è‚¡ç¥¨æ ‡è®°**

   - è¡¥å…… ST æ•°æ®
   - å®ç°è¿‡æ»¤é€»è¾‘

6. âš ï¸ **é€€å¸‚è‚¡ç¥¨å¤„ç†**
   - é€€å¸‚æ—¥æœŸæ•°æ®
   - å¼ºåˆ¶æ¸…ä»“é€»è¾‘

---

## ğŸ“‹ æ•°æ®è¡¥å……æ¸…å•

### æ€¥éœ€è¡¥å……çš„æ•°æ®

| æ•°æ®ç±»å‹ | ç›®å½•                             | ä¼˜å…ˆçº§ | è¯´æ˜           |
| -------- | -------------------------------- | ------ | -------------- |
| åœç‰Œæ•°æ® | `stockdata/stockdata/åœç‰Œæ•°æ®/`  | ğŸ”´ é«˜  | å½±å“äº¤æ˜“å¯è¡Œæ€§ |
| ST æ ‡è®°  | `stockdata/stockdata/st_status/` | ğŸŸ¡ ä¸­  | é£é™©æ§åˆ¶       |
| é€€å¸‚æ•°æ® | `stockdata/stockdata/é€€å¸‚æ•°æ®/`  | ğŸŸ¢ ä½  | è¾¹ç¼˜æƒ…å†µ       |
| æ¿å—åˆ†ç±» | `stockdata/stockdata/æ¿å—åˆ†ç±»/`  | ğŸŸ¡ ä¸­  | æ¶¨è·Œå¹…å·®å¼‚     |

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### åˆ›å»ºæµ‹è¯•ç”¨ä¾‹

1. **T+1 æµ‹è¯•**

   ```python
   # æµ‹è¯•å½“æ—¥ä¹°å…¥ä¸èƒ½å½“æ—¥å–å‡º
   day1: buy 1000 shares
   day1: sell 1000 shares  # åº”è¯¥å¤±è´¥
   day2: sell 1000 shares  # åº”è¯¥æˆåŠŸ
   ```

2. **æ¶¨è·Œåœæµ‹è¯•**

   ```python
   # æµ‹è¯•æ¶¨åœä¸èƒ½ä¹°å…¥
   stock at limit_up: buy()  # åº”è¯¥å¤±è´¥
   stock at limit_down: sell()  # åº”è¯¥å¤±è´¥
   ```

3. **åœç‰Œæµ‹è¯•**
   ```python
   # æµ‹è¯•åœç‰ŒæœŸé—´ä¸èƒ½äº¤æ˜“
   if is_paused(stock):
       buy(stock)  # åº”è¯¥å¤±è´¥
   ```

---

## ğŸ“Š æ€»ä½“è¯„åˆ†

| ç»´åº¦     | å¾—åˆ†   | æ»¡åˆ†   | è¯´æ˜                 |
| -------- | ------ | ------ | -------------------- |
| è´¹ç”¨æ¨¡å‹ | 10     | 10     | å®Œç¾å®ç°             |
| æ»‘ç‚¹æ¨¡å‹ | 10     | 10     | å®Œç¾å®ç°             |
| æ¶¨è·Œåœ   | 7      | 10     | åŸºæœ¬å®ç°ï¼Œç¼ºæ¿å—å·®å¼‚ |
| T+1 åˆ¶åº¦ | 0      | 10     | **æœªå®ç°**           |
| åœç‰Œå¤„ç† | 0      | 10     | **æœªå®ç°**           |
| æ•´æ•°å€   | 5      | 10     | éƒ¨åˆ†å®ç°             |
| **æ€»åˆ†** | **32** | **60** | **53.3%**            |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2 å¤©ï¼‰

- [ ] å®ç° T+1 åˆ¶åº¦
- [ ] æ·»åŠ åœç‰Œæ•°æ®å’Œæ£€æµ‹
- [ ] éªŒè¯ 100 è‚¡æ•´æ•°å€é€»è¾‘

### ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½å®Œå–„ï¼ˆ3-5 å¤©ï¼‰

- [ ] å®ç°æ¶¨è·Œå¹…æ¿å—å·®å¼‚
- [ ] æ·»åŠ  ST è‚¡ç¥¨è¿‡æ»¤
- [ ] è¡¥å……æµ‹è¯•ç”¨ä¾‹

### ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®è¡¥å……ï¼ˆæŒç»­ï¼‰

- [ ] æ”¶é›†åœç‰Œæ•°æ®
- [ ] æ”¶é›† ST æ ‡è®°æ•°æ®
- [ ] æ”¶é›†æ¿å—åˆ†ç±»æ•°æ®

---

**è¯„ä¼°ç»“è®º**ï¼š

ä½ çš„å›æµ‹ç³»ç»Ÿåœ¨**è´¹ç”¨å’Œæ»‘ç‚¹æ¨¡å‹**æ–¹é¢å·²ç»ä¸èšå®½**å®Œå…¨ä¸€è‡´**ï¼Œè¿™æ˜¯éå¸¸å¥½çš„åŸºç¡€ã€‚ä½†æ˜¯åœ¨**äº¤æ˜“è§„åˆ™**æ–¹é¢ï¼ˆç‰¹åˆ«æ˜¯ T+1 å’Œåœç‰Œå¤„ç†ï¼‰è¿˜æœ‰æ˜æ˜¾ä¸è¶³ã€‚

å»ºè®®**ä¼˜å…ˆå®ç° T+1 åˆ¶åº¦**ï¼Œè¿™æ˜¯ A è‚¡å¸‚åœºæœ€åŸºæœ¬çš„äº¤æ˜“è§„åˆ™ï¼Œå¯¹å›æµ‹ç»“æœå½±å“å¾ˆå¤§ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**è¯„ä¼°æ—¥æœŸ**: 2025-10-08  
**è¯„ä¼°äºº**: Backtest System Analysis Team
