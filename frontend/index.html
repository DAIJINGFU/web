<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>本地回测系统</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
      :root {
        --bg: #0f141b;
        --bg-alt: #161e27;
        --panel: #1f2732;
        --panel-alt: #25313f;
        --border: #2c3a48;
        --text: #d6dde4;
        --muted: #7d8b99;
        --accent: #2f81f7;
        --accent-grad: linear-gradient(90deg, #2f81f7, #1cb5e0);
        --danger: #d64545;
        --success: #29c66f;
        --warn: #e6a23c;
        --radius: 10px;
        --code: #0b1016;
        --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono",
          monospace;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI,
          Roboto;
        background: var(--bg);
        color: var(--text);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      aside {
        width: 360px;
        background: var(--bg-alt);
        border-right: 1px solid var(--border);
        padding: 14px 18px 60px;
        overflow: auto;
      }
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      h1 {
        font-size: 20px;
        letter-spacing: 0.5px;
        margin: 4px 0 14px;
        font-weight: 600;
        background: var(--accent-grad);
        -webkit-background-clip: text;
        color: transparent;
      }
      h2.section {
        margin: 24px 0 8px;
        font-size: 15px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #97a6b5;
      }
      label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--muted);
        display: block;
        margin: 14px 0 4px;
      }
      input,
      textarea {
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        width: 100%;
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 13px;
        font-family: inherit;
      }
      textarea {
        min-height: 220px;
        font-family: var(--mono);
        line-height: 1.4;
        resize: vertical;
      }
      button {
        cursor: pointer;
        border: none;
        background: var(--accent-grad);
        color: #fff;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 6px;
        margin-top: 16px;
        width: 100%;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        transition: 0.25s;
      }
      button:disabled {
        filter: grayscale(0.6) brightness(0.7);
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.55);
      }
      small.helper {
        color: var(--muted);
        font-size: 11px;
        display: block;
        margin-top: 4px;
        line-height: 1.3;
      }
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #243344;
        font-size: 11px;
        margin-right: 6px;
      }
      /* Layout areas */
      .top-kpis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin: 8px 0 14px;
      }
      .kpi {
        background: var(--panel);
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        position: relative;
        overflow: hidden;
      }
      .kpi h3 {
        margin: 0 0 4px;
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.5px;
        color: var(--muted);
        text-transform: uppercase;
      }
      .kpi .val {
        font-size: 20px;
        font-weight: 600;
        line-height: 1;
      }
      .kpi.positive .val {
        color: var(--success);
      }
      .kpi.negative .val {
        color: var(--danger);
      }
      .panels {
        flex: 1;
        overflow: auto;
        padding: 0 18px 40px;
      }
      .panel {
        background: var(--panel-alt);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px 16px 10px;
        margin-bottom: 18px;
      }
      .panel h3 {
        margin: 0 0 10px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      #chartsGrid {
        display: grid;
        grid-template-columns: 1.4fr 1fr;
        grid-template-rows: 340px 240px 240px 240px 240px;
        gap: 14px;
      }
      .chart {
        width: 100%;
        height: 100%;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      th,
      td {
        padding: 4px 6px;
        border-bottom: 1px solid #2e3d4c;
        text-align: right;
        white-space: nowrap;
      }
      th {
        text-align: right;
        font-weight: 500;
        color: #8fa0b2;
      }
      td:first-child,
      th:first-child {
        text-align: left;
      }
      tbody tr:hover {
        background: #203040;
      }
      #log,
      #jqLogs,
      #jqRecords {
        font-family: var(--mono);
        font-size: 11px;
        background: var(--code);
        border: 1px solid #18232f;
        border-radius: 6px;
        padding: 8px 10px;
        line-height: 1.35;
        max-height: 200px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .jq-line {
        margin: 0;
      }
      .jq-ts {
        color: #5ea3ff;
      }
      .jq-lv {
        color: #29c66f;
      }
      .jq-body {
        color: #d6dde4;
      }
      .jq-cont {
        color: #b9c4cc;
      }
      #statusBar {
        margin-top: 10px;
        font-size: 12px;
        font-weight: 500;
        letter-spacing: 0.5px;
      }
      .status-running {
        color: var(--accent);
      }
      .status-error {
        color: var(--danger);
      }
      .flex-row {
        display: flex;
        gap: 14px;
      }
      .grow {
        flex: 1;
      }
      .badge {
        background: #233242;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 6px;
      }
      .split-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      footer {
        text-align: center;
        font-size: 11px;
        color: var(--muted);
        padding: 14px 0 30px;
      }
      a {
        color: #5ea3ff;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      @media (max-width: 1380px) {
        #chartsGrid {
          grid-template-columns: 1fr;
          grid-template-rows: 320px 240px 240px 240px 240px 240px 240px;
        }
      }
      @media (max-width: 980px) {
        body {
          flex-direction: column;
        }
        aside {
          width: 100%;
          height: auto;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
        main {
          height: auto;
        }
      }
    </style>
  </head>
  <body>
    <aside>
      <h1>本地回测系统</h1>
      <h2 class="section">回测参数</h2>
      <!-- 标的输入移除：改为自动从策略代码解析 g.security (或 g.security 列表) -->
      <input id="symbol" value="sample" style="display: none" />
      <label>解析到的标的 (只读, 来自 g.security)</label>
      <div
        id="parsedSymbols"
        style="min-height: 28px; display: flex; flex-wrap: wrap; gap: 6px"
      ></div>
      <small class="helper"
        >在策略代码里设置 g.security / g.security=[...] 会自动解析成数据文件名
        (XXXX_daily)。</small
      >
      <label style="margin-top: 10px">开始日期</label>
      <input id="start" type="date" value="2025-01-01" />
      <label>结束日期</label>
      <input id="end" type="date" value="2025-03-01" />
      <label>解析到的基准 (来自 set_benchmark)</label>
      <div
        id="parsedBenchmark"
        style="min-height: 24px; display: flex; flex-wrap: wrap; gap: 6px"
      ></div>
      <label>初始资金</label>
      <input id="cash" type="number" value="100000" />
      <label>策略代码 (UserStrategy 或 initialize/handle_data)</label>
      <textarea id="code" spellcheck="false">
import backtrader as bt
class UserStrategy(bt.Strategy):
    params = dict(fast=5, slow=20)
    def __init__(self):
        self.fast = bt.ind.SMA(self.data, period=self.p.fast)
        self.slow = bt.ind.SMA(self.data, period=self.p.slow)
    def next(self):
    if not self.position and self.fast[0] &gt; self.slow[0]:
            self.buy()
    elif self.position and self.fast[0] &lt; self.slow[0]:
            self.close()
</textarea
      >
      <button id="runBtn" onclick="runBacktest()">▶ 运行回测</button>
      <div id="statusBar"></div>
      <small class="helper"
        >支持 JoinQuant 风格 initialize/handle_data；多标的用逗号或在 g.security
        列表设置。</small
      >
    </aside>
    <main>
      <div class="panels">
        <div class="panel" id="kpiPanel">
          <h3>关键指标 <span class="badge" id="periodBadge"></span></h3>
          <div class="top-kpis" id="metrics"></div>
        </div>
        <div class="panel">
          <h3>图表分析</h3>
          <div id="chartsGrid">
            <div id="equityChart" class="chart"></div>
            <div id="drawdownChart" class="chart"></div>
            <div id="dailyReturnChart" class="chart"></div>
            <div id="benchmarkChart" class="chart"></div>
            <div id="excessChart" class="chart"></div>
            <div id="dailyPnlChart" class="chart"></div>
            <div id="turnoverChart" class="chart"></div>
          </div>
        </div>
        <div class="panel split-2">
          <div>
            <h3>交易记录 <span class="badge" id="tradeCount"></span></h3>
            <div style="max-height: 260px; overflow: auto">
              <table id="tradesTable">
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>方向</th>
                    <th>数量</th>
                    <th>价格</th>
                    <th>金额</th>
                    <th>佣金</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div>
            <h3>订单明细 <span class="badge" id="orderCount"></span></h3>
            <div style="max-height: 140px; overflow: auto">
              <table id="ordersTable">
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>标的</th>
                    <th>方向</th>
                    <th>数量</th>
                    <th>价格</th>
                    <th>金额</th>
                    <th>佣金</th>
                    <th>状态</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <h3 style="margin-top: 12px">日志 / 错误</h3>
            <div id="log"></div>
            <h3 style="margin-top: 18px">JQ Logs</h3>
            <div id="jqLogs"></div>
          </div>
        </div>
        <div class="panel">
          <h3>Record 记录 (近 200)</h3>
          <div id="jqRecords" style="max-height: 220px; overflow: auto"></div>
        </div>
        <footer>
          本页面纯静态 HTML + ECharts · 数据由 FastAPI /backtest 返回 · © 2025
        </footer>
      </div>
    </main>
    <script>
      const runBtn = document.getElementById("runBtn");
      const statusBar = document.getElementById("statusBar");
      function setStatus(msg, cls = "") {
        statusBar.textContent = msg;
        statusBar.className = cls;
      }

      function extractSymbolsFromCode(code) {
        // 支持 g.security = '000516.XSHE' 或 g.security=['000001.XSHE','000002.XSHE']
        // 也支持 g.security = '000516_daily'
        const singleRe = /g\.security\s*=\s*['"]([^'"\n]+)['"]/i;
        const listRe = /g\.security\s*=\s*\[([^\]]+)\]/i;
        let syms = [];
        const listMatch = code.match(listRe);
        if (listMatch) {
          const parts = listMatch[1]
            .split(/[,\n]/)
            .map((s) => s.trim())
            .filter(Boolean);
          parts.forEach((p) => {
            const m = p.match(/['"]([^'"]+)['"]/);
            if (m) syms.push(m[1]);
          });
        } else {
          const m = code.match(singleRe);
          if (m) syms.push(m[1]);
        }
        // 转换 000001.XSHE -> 000001_daily 与 .XSHG 同理
        syms = syms.map((s) => {
          const lower = s.toLowerCase();
          const preserved = [
            "_daily",
            "_daily_qfq",
            "_daily_hfq",
            "_qfq",
            "_hfq",
            "_日",
            "_日_qfq",
            "_日_hfq",
          ];
          if (preserved.some((p) => lower.endsWith(p)))
            return s.replace(".XSHE", "").replace(".XSHG", "");
          if (/\.xshe$/i.test(s) || /\.xshg$/i.test(s)) {
            const base = s.split(".")[0];
            // 新规则：标的优先显示 *_daily_qfq （与后端匹配逻辑一致）
            return base + "_daily_qfq";
          }
          return s;
        });
        // 归一化重复后缀
        syms = syms.map((s) => {
          let l = s.toLowerCase();
          const repl = [
            ["_daily_qfq_daily", "_daily_qfq"],
            ["_daily_hfq_daily", "_daily_hfq"],
            ["_日_qfq_日", "_日_qfq"],
            ["_日_hfq_日", "_日_hfq"],
            ["_daily_daily", "_daily"],
          ];
          for (const [oldv, newv] of repl) {
            if (l.endsWith(oldv)) {
              return s.slice(0, s.length - oldv.length) + newv;
            }
          }
          return s;
        });
        return syms;
      }

      function extractBenchmarkFromCode(code) {
        const bmRe = /set_benchmark\(\s*['"]([^'"\n]+)['"]\s*\)/i;
        const m = code.match(bmRe);
        if (!m) return null;
        let raw = m[1].trim();
        // 复用与证券同样的映射逻辑
        const lower = raw.toLowerCase();
        const preserved = [
          "_daily",
          "_daily_qfq",
          "_daily_hfq",
          "_qfq",
          "_hfq",
          "_日",
          "_日_qfq",
          "_日_hfq",
        ];
        if (preserved.some((p) => lower.endsWith(p)))
          return raw.replace(".XSHE", "").replace(".XSHG", "");
        if (/\.xshe$/i.test(raw) || /\.xshg$/i.test(raw)) {
          const base = raw.split(".")[0];
          // 新规则：基准优先显示 *_日
          return base + "_日";
        }
        return raw;
      }

      function renderBenchmark(bm) {
        const box = document.getElementById("parsedBenchmark");
        box.innerHTML = "";
        const span = document.createElement("span");
        span.className = "pill";
        if (!bm) {
          span.style.opacity = 0.55;
          span.textContent = "未解析到 (可在代码 set_benchmark)";
        } else span.textContent = bm;
        box.appendChild(span);
      }

      function renderParsedSymbols(list) {
        const box = document.getElementById("parsedSymbols");
        box.innerHTML = "";
        if (!list.length) {
          const span = document.createElement("span");
          span.className = "pill";
          span.style.opacity = 0.55;
          span.textContent = "未解析到 (使用旧 symbol 或未设 g.security)";
          box.appendChild(span);
          return;
        }
        list.forEach((s) => {
          const span = document.createElement("span");
          span.className = "pill";
          span.textContent = s;
          box.appendChild(span);
        });
      }

      // 初次与输入时解析显示
      const codeTextarea = document.getElementById("code");
      function refreshParsed() {
        const code = codeTextarea.value;
        const list = extractSymbolsFromCode(code);
        renderParsedSymbols(list);
        renderBenchmark(extractBenchmarkFromCode(code));
      }
      codeTextarea.addEventListener("input", () => {
        // 去抖可选; 这里直接刷新
        refreshParsed();
      });
      document.addEventListener("DOMContentLoaded", refreshParsed);

      async function runBacktest() {
        if (runBtn.disabled) return;
        setStatus("正在运行回测...", "status-running");
        runBtn.disabled = true;
        runBtn.textContent = "运行中...";
        const code = document.getElementById("code").value;
        const extracted = extractSymbolsFromCode(code);
        const benchParsed = extractBenchmarkFromCode(code);
        renderParsedSymbols(extracted); // 运行前刷新
        renderBenchmark(benchParsed);
        const payload = {
          symbol:
            extracted.join(",") ||
            document.getElementById("symbol").value.trim(),
          start: document.getElementById("start").value,
          end: document.getElementById("end").value,
          cash: parseFloat(document.getElementById("cash").value),
          strategy_code: code,
          benchmark_symbol: null, // 交由后端自动解析 set_benchmark
        };
        if (!extracted.length) {
          // 给用户提示仍可兼容旧写法
          console.log(
            "未从代码中解析到 g.security, 使用隐藏 symbol 字段 fallback"
          );
        }
        try {
          const res = await fetch("/api/backtest", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          window.lastResult = data;
          if (data.metrics && !data.metrics.error) {
            setStatus("完成", "");
            renderResult(data);
          } else {
            throw new Error("回测失败\n" + (data.log || ""));
          }
        } catch (err) {
          console.error(err);
          setStatus("错误: " + err.message, "status-error");
          document.getElementById("log").textContent = err.stack || err.message;
        } finally {
          runBtn.disabled = false;
          runBtn.textContent = "▶ 运行回测";
        }
      }

      function formatMetricValue(k, v) {
        if (v === null || v === undefined) return "-";
        if (typeof v === "number") {
          // α 显示更高精度（日度 α 往往很小，避免被 3 位小数四舍五入到 0.000）
          if (k === "alpha") return v.toFixed(6);
          if (["final_value"].includes(k)) return v.toFixed(2);
          if (/(pct|rate|return|win|drawdown|excess|rt_annual)/i.test(k)) {
            // raw ratio display as % if in -5..5
            if (Math.abs(v) < 5) return (v * 100).toFixed(2) + "%";
          }
          // α 与 α(年化) 都按小数显示（不加百分号）
          // 确保最大回撤使用百分号（后端常给 0.0778 这样的比例）
          if (k === "max_drawdown" && Math.abs(v) <= 1.5) {
            return (v * 100).toFixed(2) + "%";
          }
          return v.toFixed(3);
        }
        return v;
      }

      function renderKPIs(metrics) {
        // 指标中文说明（悬浮提示）
        const help = {
          pnl_pct:
            "策略收益：回测期末总收益率 = 期末资产/初始资金 - 1（展示为百分比）",
          benchmark_return:
            "基准收益：基准累计净值的终值 - 1。说明：基准净值从起始日前一个交易日的收盘价进行归一，避免跨年或非交易日造成偏移。",
          excess_return:
            "超额收益：策略相对基准的累计收益差 = 策略终值/基准终值 - 1",
          rt_annual:
            "年化：根据日收益换算的年化收益率（Backtrader Returns 分析器计算）",
          sharpe:
            "夏普：风险调整后收益 = 年化超额收益 / 年化波动，数值越高越好（无单位，不以%显示）",
          max_drawdown:
            "最大回撤：整个回测期间相对历史峰值的最大回撤幅度（负值，绝对值越大越差）",
          win_rate: "胜率：盈利交易笔数 / 总交易笔数",
          total_trades:
            "总交易：回测期间成交（平仓/开仓）统计的总笔数（按 Backtrader 交易统计器）",
          alpha:
            "阿尔法：CAPM 模型中的 α 值（默认按年化显示，若后端 set_option('alpha_unit','daily') 则显示日度；均不以%展示）",
          beta: "β：CAPM 模型中的 β 值，衡量策略相对基准的系统性风险敞口（无单位，可为负）",
          drawdown_interval:
            "回撤区间：最大回撤发生时，从历史峰值日期到最低点日期的时间区间",
        };
        const order = [
          ["pnl_pct", "策略收益"],
          ["benchmark_return", "基准收益"],
          ["excess_return", "超额收益"],
          ["rt_annual", "年化"],
          ["sharpe", "夏普(年化)"],
          ["alpha", "阿尔法"],
          ["beta", "β"],
          ["max_drawdown", "最大回撤"],
          ["win_rate", "胜率"],
          ["total_trades", "总交易"],
          ["drawdown_interval", "回撤区间"],
        ];
        const wrap = document.getElementById("metrics");
        wrap.innerHTML = "";
        order.forEach(([k, label]) => {
          if (!(k in metrics)) return;
          const v = metrics[k];
          const box = document.createElement("div");
          box.className = "kpi";
          if (help[k]) box.setAttribute("title", help[k]);
          const classMod =
            typeof v === "number" &&
            ["pnl_pct", "excess_return", "rt_annual", "win_rate"].includes(k)
              ? v >= 0
                ? " positive"
                : " negative"
              : "";
          box.className += classMod;
          box.innerHTML = `<h3>${label}</h3><div class="val">${formatMetricValue(
            k,
            v
          )}</div>`;
          wrap.appendChild(box);
        });
      }

      function computeDrawdown(equity) {
        let peak = -Infinity;
        const series = [];
        for (const p of equity) {
          if (p.equity > peak) peak = p.equity;
          const dd = peak === 0 ? 0 : p.equity / peak - 1;
          series.push({ date: p.date, dd });
        }
        return series; // dd <= 0
      }

      function drawCharts(
        equity,
        returns,
        benchmark,
        excess,
        dailyPnl,
        dailyTurnover
      ) {
        const theme = {
          textStyle: { color: "#b9c4cc" },
          tooltip: { trigger: "axis" },
          grid: { left: 50, right: 20, top: 40, bottom: 40 },
        };
        const dates = equity.map((x) => x.date);
        // Equity & benchmark
        const eqDiv = document.getElementById("equityChart");
        if (eqDiv)
          eqDiv.title =
            "权益曲线：策略累计净值（从起始日归一到 1），按每日收益率连乘得到。";
        const eqChart = echarts.init(eqDiv);
        eqChart.setOption({
          ...theme,
          title: { text: "权益曲线", left: 10 },
          legend: {
            data: ["策略", "基准"],
            top: 4,
            textStyle: { color: "#9fb0bd" },
          },
          xAxis: { type: "category", data: dates },
          yAxis: { type: "value" },
          series: [
            {
              name: "策略",
              type: "line",
              smooth: true,
              showSymbol: false,
              data: equity.map((x) => x.equity),
              lineStyle: { width: 1.8 },
            },
            ...(benchmark?.length
              ? [
                  {
                    name: "基准",
                    type: "line",
                    smooth: true,
                    showSymbol: false,
                    data: benchmark.map((x) => x.equity),
                    lineStyle: { width: 1, type: "dashed" },
                  },
                ]
              : []),
          ],
        });
        // Drawdown
        const ddSeries = computeDrawdown(equity);
        const ddDiv = document.getElementById("drawdownChart");
        if (ddDiv)
          ddDiv.title =
            "回撤(%)：相对历史最高净值的跌幅比例（≤0），数值越低代表回撤越大。";
        const ddChart = echarts.init(ddDiv);
        ddChart.setOption({
          ...theme,
          title: { text: "回撤(%)", left: 10 },
          xAxis: { type: "category", data: dates },
          yAxis: {
            type: "value",
            axisLabel: { formatter: (v) => (v * 100).toFixed(0) },
          },
          series: [
            {
              type: "bar",
              data: ddSeries.map((x) => (x.dd * 100).toFixed(2)),
              itemStyle: { color: "#d64545" },
            },
          ],
        });
        // Daily returns
        const drDiv = document.getElementById("dailyReturnChart");
        if (drDiv)
          drDiv.title =
            "日收益(%)：当天收益率 = 当日净值/前一日净值 - 1（以百分比展示）。";
        const drChart = echarts.init(drDiv);
        drChart.setOption({
          ...theme,
          title: { text: "日收益(%)", left: 10 },
          xAxis: { type: "category", data: returns.map((x) => x.date) },
          yAxis: { type: "value" },
          series: [
            {
              type: "bar",
              data: returns.map((x) => (x.ret * 100).toFixed(2)),
              itemStyle: {
                color: (params) => (params.value >= 0 ? "#29c66f" : "#d64545"),
              },
            },
          ],
        });
        // Benchmark vs strategy already covered in first; reuse for excess & cum excess
        const bmDiv = document.getElementById("benchmarkChart");
        if (bmDiv)
          bmDiv.title =
            "策略 vs 基准(归一化)：策略与基准的累计净值对比，均从起始日归一为 1。";
        const bmChart = echarts.init(bmDiv);
        bmChart.setOption({
          ...theme,
          title: { text: "策略 vs 基准(归一化)", left: 10 },
          xAxis: { type: "category", data: dates },
          yAxis: { type: "value" },
          legend: { data: ["策略", "基准"] },
          series: [
            {
              name: "策略",
              type: "line",
              data: equity.map((x) => x.equity),
              smooth: true,
              showSymbol: false,
            },
            ...(benchmark?.length
              ? [
                  {
                    name: "基准",
                    type: "line",
                    data: benchmark.map((x) => x.equity),
                    smooth: true,
                    showSymbol: false,
                  },
                ]
              : []),
          ],
        });
        const exDiv = document.getElementById("excessChart");
        if (exDiv)
          exDiv.title =
            "超额累计(%)：策略相对基准的累计超额 = 策略累计净值/基准累计净值 - 1（以%展示）。";
        const exChart = echarts.init(exDiv);
        exChart.setOption({
          ...theme,
          title: { text: "超额累计(%)", left: 10 },
          xAxis: { type: "category", data: excess.map((x) => x.date) },
          yAxis: { type: "value" },
          series: [
            {
              type: "line",
              data: excess.map((x) => (x.excess * 100).toFixed(2)),
              smooth: true,
              showSymbol: false,
              areaStyle: { opacity: 0.15 },
            },
          ],
        });
        // Daily P&L (金额)
        const dpDiv = document.getElementById("dailyPnlChart");
        if (dpDiv)
          dpDiv.title = "每日盈亏：以金额展示 = 前一日权益 × 当日收益率";
        const dpChart = echarts.init(dpDiv);
        dpChart.setOption({
          ...theme,
          title: { text: "每日盈亏(¥)", left: 10 },
          xAxis: {
            type: "category",
            data: (dailyPnl || []).map((x) => x.date),
          },
          yAxis: { type: "value" },
          series: [
            {
              type: "bar",
              data: (dailyPnl || []).map((x) => x.pnl || 0),
              itemStyle: {
                color: (p) => (p.value >= 0 ? "#29c66f" : "#d64545"),
              },
            },
          ],
          tooltip: {
            trigger: "axis",
            formatter: (items) => {
              const it = items && items[0];
              if (!it) return "";
              const row = (dailyPnl || [])[it.dataIndex] || {};
              const pnl = Number(row.pnl || 0).toFixed(2);
              const eq = Number(row.equity || 0).toFixed(2);
              return `${row.date}<br/>当日盈亏: ${pnl}<br/>当日收盘权益: ${eq}`;
            },
          },
        });
        // Daily Turnover (买卖额)
        const toDiv = document.getElementById("turnoverChart");
        if (toDiv)
          toDiv.title =
            "每日买卖额：按成交金额汇总，绿色=买入额，红色=卖出额；提示里含开/平仓次数";
        const toChart = echarts.init(toDiv);
        const toDates = (dailyTurnover || []).map((x) => x.date);
        toChart.setOption({
          ...theme,
          title: { text: "每日买卖额(¥)", left: 10 },
          xAxis: { type: "category", data: toDates },
          yAxis: { type: "value" },
          legend: { data: ["买入", "卖出"] },
          series: [
            {
              name: "买入",
              type: "bar",
              stack: "turnover",
              data: (dailyTurnover || []).map((x) => x.buy_amt || 0),
              itemStyle: { color: "#29c66f" },
            },
            {
              name: "卖出",
              type: "bar",
              stack: "turnover",
              data: (dailyTurnover || []).map((x) => -(x.sell_amt || 0)),
              itemStyle: { color: "#d64545" },
            },
          ],
          tooltip: {
            trigger: "axis",
            formatter: (items) => {
              const idx = items && items[0] ? items[0].dataIndex : 0;
              const row = (dailyTurnover || [])[idx] || {};
              const b = Number(row.buy_amt || 0).toFixed(2);
              const s = Number(row.sell_amt || 0).toFixed(2);
              return `${
                row.date
              }<br/>买入额: ${b}<br/>卖出额: ${s}<br/>开仓数: ${
                row.open_cnt || 0
              } 平仓数: ${row.close_cnt || 0}`;
            },
          },
        });
        window.addEventListener("resize", () => {
          eqChart.resize();
          ddChart.resize();
          drChart.resize();
          dpChart.resize();
          toChart.resize();
          bmChart.resize();
          exChart.resize();
        });
      }

      function renderTrades(trades) {
        const tb = document.querySelector("#tradesTable tbody");
        tb.innerHTML = "";
        trades.forEach((t) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${t.datetime || ""}</td><td>${t.side}</td><td>${
            t.size
          }</td><td>${(+t.price).toFixed(2)}</td><td>${(+t.value).toFixed(
            2
          )}</td><td>${(+t.commission).toFixed(2)}</td>`;
          tb.appendChild(tr);
        });
        document.getElementById("tradeCount").textContent =
          trades.length + " 笔";
      }

      function renderOrders(orders) {
        const tb = document.querySelector("#ordersTable tbody");
        if (!tb) return;
        tb.innerHTML = "";
        (orders || []).forEach((o) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${o.datetime || ""}</td><td>${
            o.symbol || ""
          }</td><td>${o.side || ""}</td><td>${o.size || 0}</td><td>${(
            +o.price || 0
          ).toFixed(2)}</td><td>${(+o.value || 0).toFixed(2)}</td><td>${(
            +o.commission || 0
          ).toFixed(2)}</td><td>${o.status || ""}</td>`;
          tb.appendChild(tr);
        });
        const badge = document.getElementById("orderCount");
        if (badge) badge.textContent = (orders?.length || 0) + " 笔";
      }

      function renderRecords(records) {
        const box = document.getElementById("jqRecords");
        box.innerHTML = "";
        (records || []).slice(-200).forEach((r) => {
          const div = document.createElement("div");
          div.textContent = JSON.stringify(r);
          box.appendChild(div);
        });
      }

      // 计算年化收益（前端兜底）：基于日收益序列（按 250 个交易日年化）
      function computeAnnualizedFromDailyReturns(daily) {
        if (!Array.isArray(daily) || !daily.length) return null;
        // 使用几何平均更稳健：(1+mean)^252 - 1 可能偏差，采用累计收益换算
        const cum = daily.reduce((acc, x) => acc * (1 + (+x.ret || 0)), 1);
        const n = daily.length;
        if (n <= 0) return null;
        return Math.pow(cum, 250 / n) - 1;
      }

      // 计算最大回撤区间（供后端缺失时兜底）：峰值日期 ~ 谷底日期
      function computeMaxDrawdownInterval(equity) {
        if (!Array.isArray(equity) || equity.length === 0) return null;
        let peak = -Infinity;
        let peakDate = null;
        let minDD = 0;
        let troughDate = null;
        let bestPeakDate = null;
        for (const p of equity) {
          const val = +p.equity;
          const dt = p.date;
          if (val > peak) {
            peak = val;
            peakDate = dt;
          }
          if (peak > 0) {
            const dd = val / peak - 1;
            if (dd < minDD) {
              minDD = dd;
              troughDate = dt;
              bestPeakDate = peakDate;
            }
          }
        }
        if (troughDate && bestPeakDate)
          return `${bestPeakDate} ~ ${troughDate}`;
        return null;
      }

      function renderResult(data) {
        // 克隆并填充前端可推导的指标
        const derived = { ...(data.metrics || {}) };
        if (derived.rt_annual === null || derived.rt_annual === undefined) {
          const rt = computeAnnualizedFromDailyReturns(data.daily_returns);
          if (rt !== null) derived.rt_annual = rt;
        }
        // 使用后端提供的回撤区间；若缺失则前端兜底计算
        if (!derived.drawdown_interval) {
          const ddInt = computeMaxDrawdownInterval(data.equity_curve);
          if (ddInt) derived.drawdown_interval = ddInt;
        }
        renderKPIs(derived);
        document.getElementById("log").textContent = data.log || "";
        renderJQLogs(data.jq_logs || []);
        renderRecords(data.jq_records || []);
        drawCharts(
          data.equity_curve || [],
          data.daily_returns || [],
          data.benchmark_curve || [],
          data.excess_curve || [],
          data.daily_pnl || [],
          data.daily_turnover || []
        );
        renderTrades(data.trades || []);
        renderOrders(data.orders || []);
        if (data.equity_curve?.length) {
          const start = data.equity_curve[0].date,
            end = data.equity_curve[data.equity_curve.length - 1].date;
          document.getElementById("periodBadge").textContent =
            start + " ~ " + end;
        } else document.getElementById("periodBadge").textContent = "";
      }

      function renderJQLogs(lines) {
        const box = document.getElementById("jqLogs");
        box.innerHTML = "";
        const tsRe =
          /^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) - (INFO|WARN|ERROR) - (.*)$/;
        lines.forEach((raw) => {
          const parts = String(raw).split(/\n/);
          parts.forEach((ln, idx) => {
            const div = document.createElement("div");
            div.className = "jq-line";
            if (idx === 0) {
              const m = ln.match(tsRe);
              if (m) {
                const ts = document.createElement("span");
                ts.className = "jq-ts";
                ts.textContent = m[1] + " ";
                const lv = document.createElement("span");
                lv.className = "jq-lv";
                lv.textContent = m[2] + " ";
                const body = document.createElement("span");
                body.className = "jq-body";
                body.textContent = m[3];
                div.appendChild(ts);
                div.appendChild(document.createTextNode("- "));
                div.appendChild(lv);
                div.appendChild(document.createTextNode("- "));
                div.appendChild(body);
              } else {
                div.textContent = ln;
              }
            } else {
              const cont = document.createElement("span");
              cont.className = "jq-cont";
              cont.textContent = "    " + ln;
              div.appendChild(cont);
            }
            box.appendChild(div);
          });
        });
      }
    </script>
  </body>
</html>
