# 股票池模块集成总结

## ✅ 已完成的工作

### 1. 创建股票池数据加载模块 `backend/app/stock_pool.py`

实现了以下聚宽兼容 API：

| 函数名                  | 功能描述               | 状态                |
| ----------------------- | ---------------------- | ------------------- |
| `get_index_stocks()`    | 获取指数成分股列表     | ✅ 已实现           |
| `get_index_weights()`   | 获取指数成分股权重     | ✅ 已实现           |
| `get_industry_stocks()` | 获取行业成分股列表     | ✅ 已实现（需数据） |
| `get_concept_stocks()`  | 获取概念板块成分股列表 | ✅ 已实现（需数据） |
| `get_all_securities()`  | 获取全市场证券列表     | ✅ 已实现（需数据） |

**辅助函数**：

- `get_available_indexes()` - 列出本地可用的所有指数
- `list_local_data_status()` - 检查本地数据完整性状态

### 2. 集成到回测引擎 `backend/app/backtest_engine.py`

✅ 已在以下位置添加股票池函数：

- `ALLOWED_GLOBALS` - 允许策略直接调用
- `_build_jq_compat_env()` - 注入到聚宽兼容环境

### 3. 创建示例策略 `strategies/stock_pool_example.py`

演示如何使用股票池功能：

- 获取指数成分股
- 获取成分股权重
- 基于权重进行股票筛选
- 定期调仓逻辑

### 4. 创建测试脚本 `scripts/test_stock_pool.py`

✅ 测试结果：

- ✅ 深交所 318 个指数数据可用
- ✅ 成功获取深证成指(399001.SZ) 500 只成分股
- ✅ 成功获取创业板指(399006.SZ) 100 只成分股
- ✅ 权重数据正常（总和 100%）

### 5. 创建数据说明文档 `STOCK_POOL_DATA_README.md`

详细说明了：

- 现有数据目录的作用
- 缺少数据的类型和优先级
- 数据格式规范
- 数据补充建议

---

## 📁 stockdata 目录结构说明

```
stockdata/stockdata/
├── 1d_1w_1m/              # ✅ 股票日/周/月线行情数据
│   ├── 000001/
│   │   ├── 000001_daily.csv        # 日线未复权
│   │   ├── 000001_daily_qfq.csv    # 日线前复权
│   │   ├── 000001_daily_hfq.csv    # 日线后复权
│   │   ├── 000001_weekly.csv       # 周线
│   │   └── 000001_monthly.csv      # 月线
│   └── ...
│
├── 1min/                  # ✅ 分钟级行情数据
│   ├── sh600010.csv
│   ├── sz000001.csv
│   └── ...
│
├── indicator/             # ✅ 基本面指标数据
│   ├── 000001.SZ.csv     # 包含：市盈率、市净率、换手率等
│   └── ...
│
├── 基准指数数据/          # ✅ 指数行情数据
│   ├── 000001_日.csv     # 上证指数
│   ├── 000300_日.csv     # 沪深300
│   └── ...
│
├── 深交所指数成分_20250829/  # ✅ 深交所指数成分及权重（318个）
│   ├── 399001.SZ.csv     # 深证成指（500只成分股）
│   ├── 399006.SZ.csv     # 创业板指（100只成分股）
│   └── ...
│
├── 行业分类/              # ❌ 需要补充 - 行业成分股数据
│   ├── I64.csv           # 计算机行业
│   └── ...
│
├── 概念板块/              # ❌ 需要补充 - 概念板块成分股数据
│   ├── SC0084.csv        # 雄安概念
│   └── ...
│
└── stock_list/           # ❌ 需要补充 - 全市场股票列表
    ├── stock.csv         # 所有股票
    ├── fund.csv          # 基金
    └── ...
```

---

## 🔴 需要补充的数据（优先级排序）

### 高优先级（立即补充）

#### 1. 上交所指数成分数据

**目录**：`stockdata/stockdata/上交所指数成分_20250829/`

**需要的指数**：

- `000300.SH` - 沪深 300 ⭐⭐⭐
- `000016.SH` - 上证 50
- `000905.SH` - 中证 500
- `000852.SH` - 中证 1000
- `000001.SH` - 上证指数

**文件格式**：

```csv
指数代码,成分股票代码,交易日期,权重
000300.SH,600519.SH,20250829,3.5
000300.SH,600036.SH,20250829,2.8
...
```

#### 2. 行业分类数据

**目录**：`stockdata/stockdata/行业分类/`

**推荐使用**：申万行业分类

- 一级行业：28 个（如银行、房地产、计算机等）
- 二级行业：104 个

**文件格式**：

```csv
行业代码,股票代码,交易日期,行业名称,行业级别
I64,000001.SZ,20250829,计算机应用,二级
I64,300059.SZ,20250829,计算机应用,二级
...
```

#### 3. 全市场股票列表

**目录**：`stockdata/stockdata/stock_list/`

**文件格式**：

```csv
code,display_name,name,start_date,end_date,type
000001.SZ,平安银行,PAYH,1991-04-03,,stock
600000.SH,浦发银行,PFYH,1999-11-10,,stock
...
```

### 中优先级（尽快补充）

#### 4. 概念板块数据

**目录**：`stockdata/stockdata/概念板块/`

**常见概念**：

- `SC0001` - 人工智能
- `SC0002` - 新能源汽车
- `SC0003` - 半导体芯片
- `SC0084` - 雄安新区
- ...

#### 5. 指数成分历史数据（时间序列）

当前只有单一时间点（20250829），建议补充月度历史快照。

---

## 💡 使用示例

### 示例 1：在策略中获取指数成分股

```python
def initialize(context):
    g.security = '399001.SZ'  # 深证成指

def handle_data(context, data):
    # 获取成分股列表
    stocks = get_index_stocks('399001.SZ')
    log.info(f"深证成指成分股数量: {len(stocks)}")

    # 获取权重数据
    weights_df = get_index_weights('399001.SZ')

    # 选择权重最大的10只股票
    top10 = weights_df.nlargest(10, 'weight')
    log.info(f"权重最大的10只股票: {top10['code'].tolist()}")
```

### 示例 2：行业轮动策略（需要补充行业数据）

```python
def initialize(context):
    g.industries = ['I64', 'I65', 'I70']  # 计算机、传媒、医药

def handle_data(context, data):
    for industry in g.industries:
        try:
            stocks = get_industry_stocks(industry)
            log.info(f"行业 {industry} 股票数: {len(stocks)}")
        except Exception as e:
            log.info(f"行业数据缺失: {e}")
```

---

## 🧪 测试方法

运行测试脚本检查数据状态：

```bash
python scripts/test_stock_pool.py
```

**测试结果示例**：

```
✅ 深交所指数成分数据: 318个指数可用
✅ 399001.SZ (深证成指): 500只成分股
✅ 399006.SZ (创业板指): 100只成分股
❌ 000300.SH (沪深300): 数据缺失
⚠️ 行业分类数据: 目录不存在
⚠️ 概念板块数据: 目录不存在
```

---

## 📖 相关文件

| 文件路径                           | 说明             |
| ---------------------------------- | ---------------- |
| `backend/app/stock_pool.py`        | 股票池核心模块   |
| `backend/app/backtest_engine.py`   | 已集成股票池函数 |
| `strategies/stock_pool_example.py` | 使用示例策略     |
| `scripts/test_stock_pool.py`       | 测试脚本         |
| `STOCK_POOL_DATA_README.md`        | 详细数据说明文档 |

---

## 🎯 下一步工作

1. **补充上交所指数数据**（最高优先级）
   - 至少补充沪深 300 (000300.SH) 的成分数据
2. **补充行业分类数据**
   - 建议使用申万一级/二级行业分类
3. **补充全市场股票列表**
   - 包含上市日期、退市状态等信息
4. **补充历史时间序列**
   - 建议按月保存指数成分快照
   - 至少保留 3-5 年历史数据

---

**版本**: v1.0  
**日期**: 2025-10-08  
**状态**: ✅ 股票池模块已完成，等待数据补充
