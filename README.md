# æœ¬åœ°ç±»èšå®½å›æµ‹å¹³å° (åŸºäº backtrader + FastAPI)

uvicorn backend.app.main:app --reload
http://127.0.0.1:8000/

## ç›®æ ‡

æ­å»ºä¸€ä¸ªè½»é‡æœ¬åœ°å›æµ‹ç³»ç»Ÿï¼šåœ¨æµè§ˆå™¨ä¸­ç²˜è´´/ç¼–å†™ç­–ç•¥ä»£ç ï¼Œè®¾ç½®æ—¶é—´åŒºé—´ã€åˆå§‹èµ„é‡‘ã€æ ‡çš„ç­‰å‚æ•°ï¼Œç‚¹å‡»è¿è¡Œåè·å¾—å›æµ‹ç»“æœï¼ˆæ”¶ç›Šæ›²çº¿ã€æ ¸å¿ƒæŒ‡æ ‡ã€äº¤æ˜“æ˜ç»†ï¼‰ï¼Œç±»ä¼¼èšå®½çš„åŸºæœ¬äº¤äº’ã€‚

## æ¶æ„æ¦‚è§ˆ

```
Browser (HTML/JS + Chart)
   |
   |  HTTP (JSON)
   v
FastAPI Backend  ------------------------------
  /api/backtest  (POST)  -> è°ƒç”¨ backtest_engine.run_backtest()
                                  |
                                  v
                           Backtrader (Cerebro)
                                  |
                           åŠ¨æ€åŠ è½½ç”¨æˆ·ç­–ç•¥ (exec å®‰å…¨å­å‘½åç©ºé—´)
                                  |
                           è¯»å–æœ¬åœ°CSVæ•°æ®  data/<symbol>.csv
                                  |
                           åˆ†æå™¨ analyzers (Sharpe, DrawDown, Returns, TradeAnalyzer)
```

## å…³é”®æ¨¡å—

- `backend/app/backtest_engine.py` å°è£…å›æµ‹é€»è¾‘ï¼š
  - åŠ¨æ€ç¼–è¯‘ç”¨æˆ·æäº¤çš„ç­–ç•¥ä»£ç ï¼Œè¦æ±‚å®šä¹‰ `UserStrategy(bt.Strategy)`ã€‚
  - åŠ è½½æŒ‡å®šæ ‡çš„æ•°æ® (å½“å‰ç‰ˆæœ¬ï¼šä» `data/<symbol>.csv` è¯»å–ï¼ŒCSV éœ€åŒ…å« `datetime,open,high,low,close,volume` åˆ—)ã€‚
  - è¿è¡Œ analyzers æ”¶é›†æŒ‡æ ‡ï¼šæ€»æ”¶ç›Šã€å¹´åŒ–ã€å¤æ™®ã€æœ€å¤§å›æ’¤ã€èƒœç‡ã€äº¤æ˜“æ¬¡æ•°ç­‰ã€‚
  - ä½¿ç”¨ `TimeReturn` æ„å»ºæ¯æ—¥æ”¶ç›Š & æƒç›Šæ›²çº¿ã€‚
  - è¿”å›ç»Ÿä¸€ JSONï¼š`metrics`, `equity_curve`, `daily_returns`, `trades`, `log`ã€‚
- `backend/app/main.py` FastAPI å…¥å£ï¼š
  - `POST /api/backtest` æ¥æ”¶å‚æ•°ä¸ç­–ç•¥ä»£ç ã€‚
  - æä¾›é™æ€æ–‡ä»¶ä¸ `index.html` å‰ç«¯é¡µé¢ã€‚
- `frontend/index.html` ç®€å•å•é¡µï¼š
  - è¡¨å•è¾“å…¥ï¼šæ ‡çš„ã€å¼€å§‹/ç»“æŸæ—¥æœŸã€åˆå§‹èµ„é‡‘ã€ç­–ç•¥ä»£ç ã€‚
  - æäº¤åä»¥ `fetch` è°ƒç”¨åç«¯ï¼Œæ¸²æŸ“æŒ‡æ ‡ + å›¾è¡¨ã€‚

## æ•°æ®æ ¼å¼

ç¤ºä¾‹æ•°æ®æ–‡ä»¶ï¼š`data/000001.csv` or `data/sample.csv`

```
datetime,open,high,low,close,volume
2025-02-03,10.2,10.5,10.1,10.3,123456
...
```

æ—¥æœŸéœ€ä¸ºå¯è¢« `pd.to_datetime` è¯†åˆ«çš„å­—ç¬¦ä¸²ã€‚

### ï¼ˆæ–°å¢ï¼‰ç»Ÿä¸€æ•°æ®åŠ è½½ä¸ `stockdata/` ç›®å½•æ”¯æŒ

å½“å‰ç‰ˆæœ¬å·²å°†åº•å±‚æ•°æ®è®¿é—®æŠ½è±¡åˆ° `backend/app/data_loader.py`ï¼Œæ”¯æŒä¸¤å¥—ç›®å½•ç»“æ„ï¼š

1. æ—§ç‰ˆï¼š`data/` å¹³é“ºæ–‡ä»¶ï¼ˆä»ç„¶å…¼å®¹ï¼‰
2. æ–°ç‰ˆï¼š`stockdata/stockdata/` åˆ†å±‚ç›®å½•ç»“æ„ï¼š

- åˆ†é’Ÿçº¿ï¼š`stockdata/stockdata/1min/sz000001.csv`
- å¤šå‘¨æœŸï¼š`stockdata/stockdata/1d_1w_1m/<code>/<code>_daily[_qfq|_hfq].csv` åŠ `weekly/monthly` æ–‡ä»¶
- æŒ‡æ ‡ï¼š`stockdata/stockdata/indicator/000001.SZ.csv`

å›æµ‹å¼•æ“åŸå…ˆä½¿ç”¨çš„ `load_csv_dataframe` / `load_csv_data` å·²é‡å®šå‘åˆ°ç»Ÿä¸€åŠ è½½å™¨ï¼Œé»˜è®¤ä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆç›®å½•ï¼ˆå­˜åœ¨åˆ™ç”¨ï¼‰ï¼Œå¦åˆ™å›é€€æ—§ç›®å½•ã€‚è¿™æ ·å¯ä»¥é€æ­¥è¿ç§»æ•°æ®è€Œä¸å½±å“å†å²è„šæœ¬ã€‚

#### ç¯å¢ƒå˜é‡æ§åˆ¶

| å˜é‡                      | ç¼ºçœ                               | è¯´æ˜                                                                      |
| ------------------------- | ---------------------------------- | ------------------------------------------------------------------------- |
| `PREFER_STOCKDATA`        | `1`                                | ä¸º `1` æ—¶ä¼˜å…ˆåœ¨æ–°ç‰ˆ `stockdata/` ä¸­æŸ¥æ‰¾ï¼›è®¾ä¸º `0` å¼ºåˆ¶åªç”¨æ—§ `data/` ç›®å½• |
| `ADJUST_TYPE`             | `auto`                             | å¯¹åº”ä¹‹å‰çš„ `adjust_type` é€»è¾‘ï¼š`auto/raw/qfq/hfq`                         |
| `BACKTEST_DATA_ROOT`      | `é¡¹ç›®æ ¹/data`                      | æŒ‡å®šæ—§ç‰ˆæ•°æ®ç›®å½•æ ¹è·¯å¾„                                                    |
| `BACKTEST_STOCKDATA_ROOT` | è‡ªåŠ¨æ¢æµ‹                           | æŒ‡å®šæ–°ç‰ˆ `stockdata/stockdata` æ ¹è·¯å¾„                                     |
| `BACKTEST_BENCHMARK_ROOT` | `stockdata/stockdata/åŸºå‡†æŒ‡æ•°æ•°æ®` | æŒ‡å®šåŸºå‡†æŒ‡æ•°æ•°æ®ç›®å½•ï¼ˆå« 000300\_æ—¥.csv ç­‰ï¼‰ï¼›æœªè®¾æ—¶è‡ªåŠ¨æ‰«æè¯¥å†…ç½®ç›®å½•    |

ç¤ºä¾‹ï¼ˆWindows PowerShellï¼‰ï¼š

```powershell
$env:PREFER_STOCKDATA = '1'
$env:ADJUST_TYPE = 'qfq'
python scripts/smoke_test.py
```

#### ç›´æ¥è°ƒç”¨æ–°åŠ è½½å™¨ï¼ˆå¯é€‰ï¼‰

```python
from backend.app import data_loader as dl
df = dl.load_price_dataframe('600008.XSHG', '2019-01-01', '2020-01-01', frequency='daily', adjust='auto')
feed = dl.load_bt_feed('600008.XSHG', '2019-01-01', '2020-01-01')
```

#### æ”¯æŒçš„é¢‘ç‡

- `daily` / `weekly` / `monthly` ï¼ˆæ¥è‡ª `1d_1w_1m/<code>/`ï¼‰

  > æ³¨æ„ï¼šå·²ç§»é™¤â€œè‡ªåŠ¨è¡¥é½ç¼ºå¤±äº¤æ˜“æ—¥å¹¶å‰å€¼å¡«å……â€åŠŸèƒ½ï¼Œç°åœ¨åªä½¿ç”¨æ•°æ®æ–‡ä»¶ä¸­çœŸå®å­˜åœ¨çš„äº¤æ˜“æ—¥è¡Œï¼›å¦‚æœæºæ•°æ®ç¼ºæŸäº›æœ¬åº”å­˜åœ¨çš„äº¤æ˜“æ—¥ï¼Œè¯¥æ—¥å°†å®Œå…¨è·³è¿‡ï¼ˆä¸ä¼šå†å‡ºç° gap_fill æ ‡è®°ï¼‰ã€‚

- `1min` ï¼ˆæ¥è‡ª `1min/`ï¼‰

> ç›®å‰å›æµ‹ä¸»æµç¨‹ä»æŒ‰æ—¥çº¿èŠ‚å¥è¿è¡Œï¼›åˆ†é’Ÿçº¿æ¥å£å¯ç”¨äºåç»­æ‰©å±•åˆ°æ—¥å†…æˆ–èšåˆå†å›æµ‹ã€‚

#### è‡ªåŠ¨åˆ—åæ˜ å°„

åŠ è½½å™¨ä¼šç»Ÿä¸€å°†ä¸­æ–‡/å˜ä½“åˆ—æ˜ å°„ä¸ºï¼š`datetime, open, high, low, close, volume, amount, code`ï¼›è‹¥ç¼ºå°‘ `volume` ä¼šè‡ªåŠ¨è¡¥é›¶ä»¥æ»¡è¶³ backtrader è¦æ±‚ã€‚

#### ä»£ç è§„èŒƒåŒ–

è¾“å…¥ä»£ç å¯æ¥å—ï¼š`600008.XSHG`, `600008`, `000001.SZ` ç­‰å½¢å¼ï¼›å†…éƒ¨ç»Ÿä¸€æ‹†åˆ†ä¸ºå…­ä½ä»£ç  + äº¤æ˜“æ‰€ï¼Œä»¥åŒ¹é…æ–‡ä»¶å‘½åï¼ˆåˆ†é’Ÿçº¿éœ€æ ¹æ®é¦–ä½æ•°å­—çŒœæµ‹äº¤æ˜“æ‰€æ—¶ï¼š6=æ²ªï¼Œå…¶å®ƒ=æ·±ï¼‰ã€‚

---

è‹¥éœ€è¦å°†ç­–ç•¥ä»£ç å±‚é¢ä¹Ÿæš´éœ²â€œé¢‘ç‡â€æˆ–â€œå¤æƒæ¨¡å¼â€é€‰æ‹©ï¼ˆä¾‹å¦‚å‰ç«¯æ–°å¢ä¸‹æ‹‰æ¡†ï¼‰ï¼Œåªéœ€åœ¨è°ƒç”¨ `run_backtest` å‰è®¾ç½®å¯¹åº”ç¯å¢ƒå˜é‡æˆ–æ‰©å±• `run_backtest` å‚æ•°å¹¶é€ä¼ åˆ° `data_loader`ã€‚

## ç¤ºä¾‹ç­–ç•¥ (åŒå‡çº¿)

```python
import backtrader as bt

class UserStrategy(bt.Strategy):
    params = dict(fast=5, slow=20)
    def __init__(self):
        self.sma_fast = bt.indicators.SMA(self.data, period=self.p.fast)
        self.sma_slow = bt.indicators.SMA(self.data, period=self.p.slow)
    def next(self):
        if not self.position:
            if self.sma_fast[0] > self.sma_slow[0]:
                self.buy()
        else:
            if self.sma_fast[0] < self.sma_slow[0]:
                self.sell()
```

## å®‰å…¨æ³¨æ„

å½“å‰ç‰ˆæœ¬ç›´æ¥ç”¨ `exec` æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œä»…ç”¨äºæœ¬åœ°ç ”ç©¶ã€‚ç”Ÿäº§åŒ–éœ€ï¼š

- ä»£ç æ²™ç®± / å­è¿›ç¨‹éš”ç¦»
- èµ„æº/æ—¶é—´é™åˆ¶
- ç™½åå•æ¨¡å—å¯¼å…¥æ§åˆ¶

## åç»­è§„åˆ’ (è§ README æœ«å°¾ TODO)

- å¤šè¿›ç¨‹ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCelery/RQï¼‰
- æ•°æ®é€‚é…ï¼ˆTushare / èšå®½æ•°æ®æ¥å£ç­‰ï¼‰
- å‚æ•°ä¼˜åŒ–ã€Walk-Forwardã€ç»„åˆå›æµ‹ã€å®æ—¶æ¨¡æ‹Ÿ
- ç»“æœæŒä¹…åŒ–ä¸å¤šå›æµ‹æ¯”è¾ƒ

---

## å¿«é€Ÿå¼€å§‹

1. (å¯é€‰) åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
2. å®‰è£…ä¾èµ–
3. å‡†å¤‡æ•°æ®: å°† CSV æ”¾åœ¨ `data/` ä¸‹, å‘½å `<symbol>.csv`ï¼›æ”¯æŒä¸­æ–‡åˆ—åï¼š`æ—¥æœŸ,å¼€ç›˜,æœ€é«˜,æœ€ä½,æ”¶ç›˜,æˆäº¤é‡` (å†…éƒ¨ä¼šè‡ªåŠ¨æ˜ å°„)ã€‚
4. å¯åŠ¨ FastAPI æœåŠ¡
5. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://127.0.0.1:8000/

Windows PowerShell ç¤ºä¾‹:

```
python -m venv .venv
./.venv/Scripts/Activate.ps1
pip install -r requirements.txt
uvicorn backend.app.main:app --reload
```

é¡µé¢å·¦è¾¹å¡«å†™:

- symbol: å¦‚ `000516_daily` (å¯¹åº”æ–‡ä»¶ `data/000516_daily.csv`)

# Web Backtest Demo

## å¯¹é½èšå®½æŒ‡æ ‡å£å¾„ï¼ˆSharpe/Alphaï¼‰

ä¸ºä½¿æœ¬åœ°å›æµ‹çš„å¤æ™®æ¯”ç‡ä¸é˜¿å°”æ³•å°½é‡è´´è¿‘èšå®½ï¼ˆJoinQuantï¼‰çš„å±•ç¤ºå£å¾„ï¼Œåç«¯å·²åšå¦‚ä¸‹å¤„ç†ï¼š

- é˜¿å°”æ³•/è´å¡”ï¼šé‡‡ç”¨æ—¥åº¦æ”¶ç›Šå¯¹é½åŸºå‡†ååšçº¿æ€§å›å½’ï¼Œå†æŒ‰ Jensen Î± è¿›è¡Œ Rf æ ¡æ­£ï¼›é˜¿å°”æ³•é»˜è®¤æŒ‰å¹´åŒ–ï¼ˆÃ— å¹´åŒ–å› å­ï¼‰è¾“å‡ºã€‚
  æ— é£é™©åˆ©ç‡ï¼šé»˜è®¤ 4% å¹´åŒ–ï¼ˆ0.04ï¼‰ï¼Œå¯é€šè¿‡ set_option('risk_free_rate', 0.04) è°ƒæ•´ã€‚
  å¤æ™®è®¡ç®—ï¼šé»˜è®¤ä½¿ç”¨â€œCAGR å¹´åŒ–å£å¾„â€ï¼ˆRp å¹´åŒ–ä¸æ³¢åŠ¨å¹´åŒ–çš„æ ‡å‡† Sharpe å½¢å¼ï¼‰ï¼Œä¹Ÿæ”¯æŒâ€œæ—¥åº¦è¶…é¢æ”¶ç›Šå‡å€¼æ³•â€ã€‚
  å¯é€šè¿‡ set_option('sharpe_method', 'cagr'|'mean') åˆ‡æ¢ï¼ˆé»˜è®¤ cagrï¼‰ã€‚

åœ¨ç­–ç•¥ä»£ç ï¼ˆæ— è®º backtrader æˆ–èšå®½é£æ ¼ï¼‰ä¸­ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨è¿™äº›é€‰é¡¹ï¼š

```python
# è®¾ç½®èšå®½å…¼å®¹å‚æ•°ï¼ˆåœ¨ç­–ç•¥ç±»å®šä¹‰å‰æˆ– initialize å†…ï¼‰
set_benchmark('000300.XSHG')
set_option('risk_free_rate', 0.03)           # å¹´åŒ–æ— é£é™©åˆ©ç‡ 3%
set_option('annualization_factor', 250)      # å¹´åŒ–äº¤æ˜“æ—¥æ•° 250
set_option('sharpe_method', 'mean')          # å¤æ™®è®¡ç®—å£å¾„ï¼šmean/cagr
set_option('alpha_unit', 'annual')           # é˜¿å°”æ³•è¾“å‡ºå•ä½ï¼šannual/daily
```

åç«¯åœ¨å“åº” JSON çš„ `metrics` å­—æ®µä¸­ä¹Ÿä¼šè¿”å›å®¡è®¡ä¿¡æ¯ï¼š

- `annualization_factor`, `sharpe_rf_annual`, `sharpe_method`, `alpha_unit` ç­‰ï¼Œä¾¿äºå’Œèšå®½å£å¾„å¯¹æ¯”æ ¸å¯¹ã€‚

å¦‚ä»ä¸èšå®½æœ‰å·®å¼‚ï¼Œå¸¸è§åŸå› åŒ…æ‹¬ï¼š

- åŸºå‡†æŒ‡æ•°ä¸åŒï¼ˆæˆ–æ•°æ®æºèµ·å§‹ç‚¹ä¸åŒï¼‰ã€‚
- æˆäº¤ä»·å£å¾„ä¸åŒï¼ˆ`fill_price` å¯é€‰ `open` æˆ– `close`ï¼Œé»˜è®¤ `open`ï¼‰ã€‚
- æ»‘ç‚¹/ä½£é‡‘è®¾ç½®ä¸åŒã€‚
- æ”¶ç›Šåºåˆ—æ˜¯å¦åŒ…å«é¦–ä¸ªæ ·æœ¬ã€æ˜¯å¦å¯¹é½ç¼ºå¤±æ—¥æœŸç­‰ç»†èŠ‚ã€‚

- å¼€å§‹ / ç»“æŸæ—¥æœŸ
- åˆå§‹èµ„é‡‘
- ç­–ç•¥ä»£ç  (å¿…é¡»åŒ…å« `class UserStrategy(bt.Strategy)`)

ç‚¹å‡» â€œè¿è¡Œå›æµ‹â€ åè·å¾— JSON æŒ‡æ ‡ + å‡€å€¼ / åŸºå‡† / è¶…é¢æ›²çº¿ã€‚

è¿”å›ç»“æ„ç¤ºä¾‹:

```
{
  "metrics": {"final_value":..., "pnl_pct":..., "excess_return":...},
  "equity_curve": [{"date":"2025-02-03","equity":1.01}, ...],
  "daily_returns": [{"date":"2025-02-03","ret":0.01}, ...],
  "benchmark_curve": [{"date":"2025-02-03","equity":1.0}, ...],
  "excess_curve": [{"date":"2025-02-03","excess":0.01}, ...]
}
```

`excess_curve` è®¡ç®—: ç­–ç•¥ç´¯è®¡å‡€å€¼ / åŸºå‡†ç´¯è®¡å‡€å€¼ - 1ã€‚

å½“å‰æœªè¾“å‡ºé€ç¬”äº¤æ˜“æ˜ç»† (å¯é€šè¿‡è‡ªå®šä¹‰ `notify_trade` / Observer æ‰©å±•)ã€‚

## åç»­æ”¹è¿›å»ºè®®

- ç­–ç•¥æ²™ç®±: å¤šè¿›ç¨‹ + è¶…æ—¶/å†…å­˜é™åˆ¶ + å®‰å…¨ç™½åå•ã€‚
- äº¤æ˜“æ˜ç»†ä¸è®¢å•æµæ°´: è‡ªå®šä¹‰ Observer æ”¶é›†å¹¶è¿”å›å‰ç«¯ã€‚
- å¤šæ•°æ®æº: æ”¯æŒ Akshare / Tushare / èšå®½æœ¬åœ°æ•°æ®ç»Ÿä¸€æ¥å£ã€‚
- ç»„åˆ & å¤šæ ‡çš„: åŒæ—¶åŠ è½½å¤š feed, ç»„åˆæƒé‡è°ƒæ•´ã€‚
- å‚æ•°ä¼˜åŒ–: ç½‘æ ¼/éšæœº/é—ä¼ ç®—æ³•æœç´¢, æä¾›æœ€ä¼˜å‚æ•°æŠ¥å‘Šã€‚
- Walk-Forward ä¸æ»šåŠ¨å›æµ‹ã€‚
- å›æµ‹ç»“æœæŒä¹…åŒ–ä¸å¯¹æ¯”: SQLite/PostgreSQL + å†å²è®°å½•é¡µé¢ã€‚
- æ€§èƒ½: æ•°æ®ç¼“å­˜ã€å¹¶è¡Œå¤šä»»åŠ¡é˜Ÿåˆ— (Celery / RQ)ã€‚
- å‰ç«¯å¢å¼º: Monaco Editor, ç­–ç•¥æ¨¡æ¿åº“, å›¾è¡¨è”åŠ¨, æŒ‡æ ‡å‹¾é€‰æ˜¾ç¤ºã€‚
- é£é™©æŒ‡æ ‡: Sortino, Calmar, æ³¢åŠ¨ç‡ã€åŒºé—´å›æ’¤åˆ†å¸ƒã€‚

## èšå®½(JQ) é£æ ¼ä»£ç å…¼å®¹ (å®éªŒæ€§)

ç°åœ¨å¯ä»¥ç›´æ¥ç²˜è´´åŒ…å«ä»¥ä¸‹ç»“æ„çš„èšå®½ç­–ç•¥ï¼š

```
import jqdata

def initialize(context):
  g.security = '000001.XSHE'
  set_benchmark('000300.XSHG')
  set_option('use_real_price', True)

def handle_data(context, data):
  close_data = attribute_history(g.security, 5, '1d', ['close'])
  MA5 = close_data['close'].mean()
  current_price = close_data['close'][-1]
  cash = context.portfolio.available_cash
  if current_price > 1.05 * MA5 and cash > 0:
    order_value(g.security, cash)
  elif current_price < 0.95 * MA5 and context.portfolio.positions[g.security].closeable_amount > 0:
    order_target(g.security, 0)
```

é™åˆ¶ / å·®å¼‚ï¼š

- ä»…æ”¯æŒå•æ ‡çš„ (ä½¿ç”¨ `g.security`)ã€‚
- `attribute_history` åªæ”¯æŒè·å–æœ€è¿‘ n æ ¹å¹¶ä¸” unit='1d'ï¼Œfields éœ€åŒ…å« backtrader çš„å­—æ®µ (close/open/high/low/volume)ã€‚
- `order_value` / `order_target` æ— æ‰‹ç»­è´¹ã€æ— æ»‘ç‚¹ã€æ— åˆ†ç¬”æ’®åˆã€‚
- `record` æš‚å­˜äºå†…éƒ¨ listï¼Œç›®å‰æœªè¿”å›å‰ç«¯ã€‚
- `set_benchmark` ç›®å‰åªæ˜¯è®°å½•ï¼Œä¸è‡ªåŠ¨æ›¿ä»£å‰ç«¯ benchmark å‚æ•°ï¼›æƒ³ä½¿ç”¨åŸºå‡†æ›²çº¿ä»éœ€åœ¨é¡µé¢å¡« `benchmark_symbol`ã€‚
- æœªå®ç°ï¼šåˆ†é’Ÿçº§å›æµ‹ã€åˆ†çº¢é€é…ã€å¤æƒæ¨¡å¼æ§åˆ¶ã€context.portfolio æ›´ä¸°å¯Œå­—æ®µã€‚

å¦‚æœåŒä¸€ä»£ç é‡Œæ—¢æœ‰ `UserStrategy` ç±»åˆæœ‰ `initialize/handle_data`ï¼Œä¼˜å…ˆä½¿ç”¨ `UserStrategy`ã€‚

### æ–°å¢å®éªŒæ€§æ‰©å±•

- attribute_history: ä»…æ—¥çº§, è¿”å›è´Ÿç´¢å¼• DataFrame, `df['close'][-1]` å¯ç›´æ¥å–æœ€æ–°å€¼ã€‚
- record()/log.info(): ç»“æœä¸­ä»¥ `jq_records`, `jq_logs` è¿”å›ï¼Œå¹¶åœ¨å‰ç«¯æ˜¾ç¤ºæœ€è¿‘è®°å½•ã€‚
- æ‰‹ç»­è´¹/æ»‘ç‚¹: å¯åœ¨ initialize é‡Œä½¿ç”¨ `set_option('commission', 0.0003)` ä¸ `set_option('slippage_perc', 0.0005)`ã€‚

## æ‰‹ç»­è´¹æ¨¡å‹ï¼ˆç»Ÿä¸€èšå®½é£æ ¼é»˜è®¤ï¼‰

å½“å‰ç‰ˆæœ¬å·²ç®€åŒ–ä¸ºå•ä¸€ç¡®å®šæ€§æ‰‹ç»­è´¹é€»è¾‘ï¼ˆä¸å†éœ€è¦ `fee_model='jq'`ï¼‰ï¼š

é»˜è®¤è§„åˆ™ï¼š

- ä½£é‡‘ç‡ (commission)ï¼š0.0003 ï¼ˆåŒè¾¹ï¼‰
- å•ç¬”æœ€å°ä½£é‡‘ (min_commission)ï¼š5 å…ƒ
- å–å‡ºå°èŠ±ç¨ (stamp_duty)ï¼š0.001 ï¼ˆä»…å–å‡ºå•è¾¹å¾æ”¶ï¼‰
- æ»‘ç‚¹ï¼šå¯é€‰ `slippage_perc` ç™¾åˆ†æ¯”æ»‘ç‚¹ï¼ˆè‹¥è®¾ç½®åˆ™æŒ‰æˆäº¤é‡‘é¢ \* ç™¾åˆ†æ¯”ä½“ç°åœ¨æˆäº¤ä»·çš„åç§»ï¼Œæˆ–ä¾æ® backtrader çš„å†…ç½®å®ç°ï¼‰

å¯è¦†ç›–çš„é€‰é¡¹ï¼ˆåœ¨ç­–ç•¥ `initialize` æˆ–é¡¶å±‚æ”¾ç½®ï¼‰ï¼š

```python
set_option('commission', 0.00025)      # è°ƒæ•´ä½£é‡‘ç‡
set_option('min_commission', 3)        # è°ƒæ•´æœ€å°å•ç¬”ä½£é‡‘ï¼ˆ>=0ï¼‰
set_option('stamp_duty', 0.001)        # è°ƒæ•´å–å‡ºå°èŠ±ç¨ï¼ˆ>=0ï¼‰
set_option('slippage_perc', 0.0005)    # æˆäº¤æ»‘ç‚¹ç™¾åˆ†æ¯”ï¼ˆç¤ºä¾‹ 5bpï¼‰
```

è¿è¡ŒæœŸæ—¥å¿—ä¸­ä¼šå‡ºç°ï¼š

```
[commission_setup] rate=0.0003 model=unified
[fee_config] min_commission=5.0 stamp_duty=0.001
[fee] BUY  000516_daily ... base_comm=xx adj_comm=xx stamp_duty=0.0000 final_comm=xx
[fee] SELL 000516_daily ... base_comm=xx adj_comm=xx stamp_duty=yy   final_comm=xx
```

è®¡ç®—è¯´æ˜ï¼š

1. Backtrader å…ˆæŒ‰ `value * commission` ç”ŸæˆåŸºç¡€ä½£é‡‘ã€‚
2. äºŒæ¬¡è°ƒæ•´ï¼šè‹¥ < `min_commission` åˆ™æå‡åˆ°æœ€å°å€¼ã€‚
3. è‹¥ä¸ºå–å‡ºå•ï¼Œåˆ™åŠ ä¸Š `value * stamp_duty`ã€‚
4. æœ€ç»ˆ `commission` å­—æ®µå†™å›è®¢å•æ‰§è¡Œå¯¹è±¡ï¼Œå½±å“ `pnlcomm`ã€‚

å¸¸è§éªŒè¯æ­¥éª¤ï¼š

- æå°é‡‘é¢ä¹°å…¥ï¼šç¡®è®¤ä½£é‡‘è¢«æŠ¬åˆ° 5 å…ƒã€‚
- å–å‡ºåŒç­‰é‡‘é¢ï¼šç¡®è®¤åœ¨ 5 å…ƒåŸºç¡€ä¸Šå†åŠ å°èŠ±ç¨ã€‚
- è°ƒæ•´ `min_commission` ä¸º 0ï¼šéªŒè¯å°é¢äº¤æ˜“ä½£é‡‘æŒ‰æ¯”ä¾‹èµ°ã€‚
- è°ƒæ•´ `stamp_duty` ä¸º 0ï¼šéªŒè¯å–å‡ºä¸ä¹°å…¥è´¹ç”¨å¯¹ç§°ã€‚

å’Œèšå®½å¯èƒ½ä»å­˜åœ¨çš„å·®å¼‚ï¼š

- èšå®½å¯èƒ½å¯¹åˆ†ç¬”æˆäº¤ã€æ’®åˆæ—¶ç‚¹ã€æˆæœ¬ä»·å››èˆäº”å…¥å­˜åœ¨é¢å¤–è§„åˆ™ï¼›è¿™é‡ŒæŒ‰å•ç¬”ä¸€æ¬¡æ€§æ’®åˆã€‚
- æœªæ¨¡æ‹Ÿèèµ„èåˆ¸ã€åˆ†çº¢æ´¾æ¯ã€æ‰‹ç»­è´¹æŠ˜æ‰£ç­‰é«˜çº§åœºæ™¯ã€‚

å¦‚æœéœ€è¦æ‰©å±•æ›´å¤šè´¹ç‡å±‚ï¼ˆå¦‚é˜¶æ¢¯è´¹ç‡ã€ä¸åŒå¸‚åœºä¸åŒè´¹ç‡ï¼‰ï¼Œå¯åœ¨ `backtest_engine.py` ä¸­å¯¹ `fee_config` å¢åŠ ç»“æ„ï¼Œå†åœ¨ `OrderCapture.notify_order` é‡Œç»†åˆ†é€»è¾‘ã€‚

## æ•°æ®æºä¸å¤æƒæ¨¡å¼ (adjust_type) âœ…

ä¸ºå¤åˆ»èšå®½åœ¨ `set_option('use_real_price', True/False)` ä¸ä¸åŒå¤æƒæ•°æ®ï¼ˆæœªå¤æƒ / å‰å¤æƒ / åå¤æƒï¼‰ä¸‹çš„ä¸‹å•å·®å¼‚ï¼Œåç«¯å®ç°äº†å¯é…ç½®å¤æƒç±»å‹è§£æï¼š

æ”¯æŒçš„æ–‡ä»¶å‘½åï¼ˆæ”¾ç½®äº `data/` ç›®å½•ï¼‰ï¼š

```
<code>_daily.csv         # æœªå¤æƒ (è‹±æ–‡åç¼€)
<code>_æ—¥.csv            # æœªå¤æƒ (ä¸­æ–‡åç¼€)
<code>_daily_qfq.csv     # å‰å¤æƒ
<code>_æ—¥_qfq.csv
<code>_daily_hfq.csv     # åå¤æƒ
<code>_æ—¥_hfq.csv
```

### 1. é€‰é¡¹è¯´æ˜

```python
set_option('adjust_type', 'auto')   # 'auto' | 'raw' | 'qfq' | 'hfq'
set_option('use_real_price', True)  # æ˜¯å¦ä½¿ç”¨çœŸå®æœªå¤æƒä»·æ’®åˆï¼ˆèšå®½è¯­ä¹‰ï¼‰

# å¯é€‰ï¼šæ§åˆ¶å€™é€‰åç¼€é¢å¤–é¡ºåºï¼ˆä¼šä¸ adjust_type ç”Ÿæˆçš„åºåˆ— merge å»é‡ï¼‰
set_option('data_source_preference', ['_daily','_daily_qfq','_æ—¥'])

# å¼ºåˆ¶è¦†ç›–ï¼šä¼˜å…ˆçº§æœ€é«˜ï¼ˆå­˜åœ¨åˆ™ç›´æ¥ä½¿ç”¨ï¼‰
set_option('force_data_variant', 'qfq')  # 'raw'|'daily'|'qfq'|'hfq'|'æ—¥'
```

### 2. è¯­ä¹‰è§„åˆ™

| adjust_type | use_real_price=True æ—¶å€™é€‰é¡ºåº | use_real_price=False æ—¶å€™é€‰é¡ºåº | è¯´æ˜                                                    |
| ----------- | ------------------------------ | ------------------------------- | ------------------------------------------------------- |
| raw         | raw > qfq > hfq                | raw > qfq > hfq                 | å§‹ç»ˆå°½é‡æœªå¤æƒä»·æ’®åˆ                                    |
| qfq         | qfq > raw > hfq                | qfq > raw > hfq                 | å¼ºåˆ¶å‰å¤æƒä¼˜å…ˆ                                          |
| hfq         | hfq > raw > qfq                | hfq > raw > qfq                 | å¼ºåˆ¶åå¤æƒä¼˜å…ˆ                                          |
| auto (é»˜è®¤) | raw > qfq > hfq                | qfq > raw > hfq                 | (å·²å®ç°) use_real_price=True æ—¶ä¼˜å…ˆ rawï¼›å¦åˆ™å‰å¤æƒä¼˜å…ˆ |

å†…éƒ¨ä¼šæ ¹æ®è‹±æ–‡ä¸ä¸­æ–‡ä¸¤å¥—å‘½åæ—è‡ªåŠ¨æ‰©å±•ï¼š`_daily` ä¸ `_æ—¥` åŒå±‚çº§ã€`_daily_qfq` ä¸ `_æ—¥_qfq` åŒå±‚çº§ï¼Œä»¥æå‡å‘½ä¸­ç‡ã€‚

æœ€ç»ˆåºåˆ— = (adjust_type æ¨å¯¼åºåˆ—) + (data_source_preference) å»é‡ä¿åºã€‚

### 3. å¼ºåˆ¶æŒ‡å®š

`force_data_variant` è‹¥è®¾ç½®å¹¶ä¸”ç›®æ ‡æ–‡ä»¶å­˜åœ¨ï¼Œä¼šç›´æ¥é€‰ä¸­ï¼ˆå¹¶è®°å½• `[data_source_force]` æ—¥å¿—ï¼‰ï¼Œå¿½ç•¥å…¶ä½™é¡ºåºã€‚ä¸å­˜åœ¨åˆ™å›é€€æ­£å¸¸æµç¨‹ã€‚

### 4. å®¡è®¡æ—¥å¿—

è¿è¡Œæ—¶å…³é”®æ—¥å¿—ï¼ˆæ–°ç‰ˆï¼‰ï¼š

```
[data_loader] code=000514 freq=daily adjust=auto use_real_price=True rows=XXXX file=...\000514_daily.csv
```

å«ä¹‰ï¼š

- code: æ ‡çš„åŸºç¡€ä»£ç 
- freq / adjust: åŠ è½½é¢‘ç‡ä¸å¤æƒæ¨¡å¼å‚æ•°
- use_real_price: æ˜¯å¦å¼€å¯çœŸå®ä»·ä¼˜å…ˆï¼ˆå½±å“ auto æ’åºï¼‰
- rows: åŠ è½½åçš„è¡Œæ•°ï¼ˆå«é¢„çƒ­åŒºé—´ï¼‰
- file: å®é™…é€‰ä¸­çš„ç‰©ç† CSV è·¯å¾„ï¼ˆå¯ç›´æ¥æ ¸å¯¹å…¶ close åˆ—ï¼‰

`metrics` ä¸­ä¼šæ–°å¢ï¼š

```
"adjust_type": "auto",
"data_sources_used": {"000516.XSHE": "000516_daily"}
```

### 5. ä¸‹å•ä¸äº¤æ˜“è·¯å¾„å½±å“

ç¬¬äºŒç¬”åŠåç»­äº¤æ˜“æ•°é‡å·®å¼‚ç»å¸¸æ¥è‡ªï¼š

1. å¤æƒä»· vs æœªå¤æƒä»· å¯¼è‡´å•ä½è‚¡æ•°æˆæœ¬ä¸åŒï¼Œè¿›è€Œå½±å“å‰©ä½™ç°é‡‘ã€‚
2. æœ€å°ä½£é‡‘ï¼ˆ5 å…ƒï¼‰æ”¾å¤§å°é¢æˆäº¤çš„è´¹ç”¨ç›¸å¯¹æ¯”ä¾‹ã€‚
3. order_value sizing åœ¨é€¼è¿‘å¯ç”¨ç°é‡‘çš„è¿­ä»£ä¸­ï¼Œä»·æ ¼/è´¹ç”¨å£å¾„å˜åŒ–ã€‚

é€šè¿‡è®¾ç½®ï¼š

```python
set_option('use_real_price', True)
set_option('adjust_type', 'auto')  # æˆ–æ˜¾å¼ 'raw'
```

å³å¯ç¡®ä¿ä½¿ç”¨æœªå¤æƒçœŸå®ä»·ï¼›è‹¥æƒ³å¤åˆ»â€œå‰å¤æƒä»·ä¸‹å•â€åœºæ™¯åˆ™ï¼š

```python
set_option('use_real_price', False)
set_option('adjust_type', 'qfq')   # æˆ– auto (é»˜è®¤) ä¹Ÿä¼šè½åœ¨å‰å¤æƒ
```

### 6. å…¸å‹æ’éšœæ­¥éª¤

1. æŸ¥æ‰¾ `[data_loader]` æ—¥å¿—ç¡®è®¤ file= è·¯å¾„æ˜¯å¦æŒ‡å‘æœŸæœ›çš„ `_daily` (raw) æˆ– `_daily_qfq` æ–‡ä»¶ã€‚
2. metrics['data_sources_used'] ä¸­æŸ¥çœ‹æ¯ä¸ªä»£ç çš„ç‰©ç†è·¯å¾„ã€‚
3. å¯¹æ¯”ç¬¬ä¸€ç¬”ä¸ç¬¬äºŒç¬” `[order_value_calc]` é‡Œçš„ price / comm / leftover è¯†åˆ«å·®å¼‚æ¥æºã€‚
4. åˆ‡æ¢ adjust_type = 'raw' ä¸ 'qfq' å›æ”¾ï¼ŒéªŒè¯è‚¡æ•°ä¸å‰©ä½™ç°é‡‘å·®å¼‚æ˜¯å¦æ”¶æ•›åˆ°é¢„æœŸã€‚

### 7. åç»­è§„åˆ’

- å¼•å…¥å‰/åå¤æƒå› å­è¡¨ï¼Œæ”¯æŒæŒä»“æ•°é‡ / æˆæœ¬åœ¨é™¤æƒé™¤æ¯æ—¥çš„è‡ªåŠ¨è°ƒæ•´ï¼ˆå½“å‰ç‰ˆæœ¬æœªå¤„ç†æ´¾æ¯é€è‚¡ï¼‰ã€‚
- åœ¨ "auto" æ¨¡å¼ä¸‹åŠ å…¥â€œè‹¥æŸæ—¥ raw ç¼ºå¤±è€Œ qfq å­˜åœ¨â€ çš„è·¨æ—¥åŠ¨æ€å›é€€ï¼ˆç›®å‰æ˜¯åˆå§‹åŒ–ä¸€æ¬¡æ€§é€‰å–ï¼‰ã€‚

è‹¥éœ€è¦æ‰©å±•æ›´å¤šå¸‚åœºæˆ–åˆ†é’Ÿçº§æ•°æ®ï¼Œå¯åœ¨ `backtest_engine.py` ä¸­æ‰©å±• `_resolve_adjust_pref`ã€‚æ¬¢è¿ç»§ç»­åé¦ˆå®é™…å¯¹é½èšå®½æ—¶çš„å·®å¼‚åœºæ™¯ã€‚

---

## è‚¡ç¥¨æ± æ¨¡å— (v1.0) ğŸ†•

### æ¦‚è¿°

æ–°å¢äº†ç±»ä¼¼èšå®½çš„è‚¡ç¥¨æ± åŠŸèƒ½ï¼Œæ”¯æŒåœ¨ç­–ç•¥ä¸­åŠ¨æ€è·å–æŒ‡æ•°æˆåˆ†è‚¡ã€è¡Œä¸šæˆåˆ†è‚¡ã€æ¦‚å¿µæ¿å—æˆåˆ†è‚¡ç­‰ã€‚

### å¯ç”¨å‡½æ•°

| å‡½æ•°å                                          | åŠŸèƒ½               | çŠ¶æ€          |
| ----------------------------------------------- | ------------------ | ------------- |
| `get_index_stocks(index_symbol, date=None)`     | è·å–æŒ‡æ•°æˆåˆ†è‚¡åˆ—è¡¨ | âœ… å¯ç”¨       |
| `get_index_weights(index_id, date=None)`        | è·å–æŒ‡æ•°æˆåˆ†è‚¡æƒé‡ | âœ… å¯ç”¨       |
| `get_industry_stocks(industry_code, date=None)` | è·å–è¡Œä¸šæˆåˆ†è‚¡     | âš ï¸ éœ€è¡¥å……æ•°æ® |
| `get_concept_stocks(concept_code, date=None)`   | è·å–æ¦‚å¿µæ¿å—æˆåˆ†è‚¡ | âš ï¸ éœ€è¡¥å……æ•°æ® |
| `get_all_securities(types, date=None)`          | è·å–å…¨å¸‚åœºè¯åˆ¸åˆ—è¡¨ | âš ï¸ éœ€è¡¥å……æ•°æ® |

### ä½¿ç”¨ç¤ºä¾‹

```python
def initialize(context):
    g.security = '399001.SZ'  # æ·±è¯æˆæŒ‡

def handle_data(context, data):
    # è·å–æŒ‡æ•°æˆåˆ†è‚¡
    stocks = get_index_stocks('399001.SZ')
    log.info(f"æ·±è¯æˆæŒ‡æˆåˆ†è‚¡æ•°é‡: {len(stocks)}")

    # è·å–æƒé‡æ•°æ®
    weights_df = get_index_weights('399001.SZ')

    # é€‰æ‹©æƒé‡æœ€å¤§çš„10åªè‚¡ç¥¨
    top10 = weights_df.nlargest(10, 'weight')
    log.info(f"æƒé‡æœ€å¤§çš„10åª: {top10['code'].tolist()}")
```

### ç°æœ‰æ•°æ®

âœ… **å·²æœ‰**ï¼š

- æ·±äº¤æ‰€ 318 ä¸ªæŒ‡æ•°æˆåˆ†æ•°æ®ï¼ˆæˆªè‡³ 2025-08-29ï¼‰
- åŒ…æ‹¬ï¼šæ·±è¯æˆæŒ‡(399001)ã€åˆ›ä¸šæ¿æŒ‡(399006)ç­‰

âš ï¸ **éœ€è¦è¡¥å……**ï¼š

- ä¸Šäº¤æ‰€æŒ‡æ•°ï¼ˆæ²ªæ·± 300ã€ä¸Šè¯ 50 ç­‰ï¼‰
- è¡Œä¸šåˆ†ç±»æ•°æ®
- æ¦‚å¿µæ¿å—æ•°æ®
- å…¨å¸‚åœºè‚¡ç¥¨åˆ—è¡¨

### è¯¦ç»†æ–‡æ¡£

- ğŸ“– **é›†æˆæ€»ç»“**: [STOCK_POOL_INTEGRATION_SUMMARY.md](STOCK_POOL_INTEGRATION_SUMMARY.md)
- ğŸ“– **æ•°æ®è¯´æ˜**: [STOCK_POOL_DATA_README.md](STOCK_POOL_DATA_README.md)
- ğŸ“ **ç¤ºä¾‹ç­–ç•¥**: [strategies/stock_pool_example.py](strategies/stock_pool_example.py)
- ğŸ§ª **æµ‹è¯•è„šæœ¬**: [scripts/test_stock_pool.py](scripts/test_stock_pool.py)

### æµ‹è¯•

```bash
python scripts/test_stock_pool.py
```

---
